<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShareHive - Notes</title>
  <style>
    /* --- Base & Theme (Unchanged) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --primary-color: #0077ff;
      --sidebar-bg: #ffffff;
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0,0,0,0.08);
      --note-default-bg: #ffffff; /* default note background (light theme) */
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --sidebar-bg: #2c2c2c;
      --card-bg: #333333;
      --border-color: #444;
      --shadow-color: rgba(0,0,0,0.25);
      --note-default-bg: #2f2f2f; /* slightly lighter than card-bg so note content is visible */
    }

    /* --- Navbar & Sidebar (Unchanged) --- */
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--primary-color); color: white; }
    .navbar h1 { font-size: 20px; }
    .toggle-btn { background: white; border: none; color: var(--primary-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .container { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 220px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); }
    .sidebar h2 { font-size: 16px; margin-bottom: 10px; }
    .sidebar a { display: block; text-decoration: none; color: var(--text-color); padding: 8px 10px; border-radius: 5px; margin-bottom: 5px; }
    .sidebar a:hover { background: var(--primary-color); color: white; }

    /* --- Main Content Area (Modernized) --- */
    .main { flex: 1; padding: 25px; overflow-y: auto; }
    
    /* "Add Note" Form */
    .add-note-container { max-width: 600px; margin: 0 auto 40px; }
    .add-note-form {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        padding: 15px;
        border: 1px solid var(--border-color);
    }
    .add-note-form input, .add-note-form textarea {
        width: 100%;
        border: none;
        background: transparent;
        color: var(--text-color);
        font-size: 16px;
        outline: none;
        resize: none;
    }
    .add-note-form input { font-weight: bold; margin-bottom: 10px; }
    .add-note-form textarea { line-height: 1.5; }
    .form-footer { display: none; justify-content: flex-end; margin-top: 15px; }
    .form-footer button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
    }
    .add-note-form.expanded .form-footer { display: flex; }
    .add-note-form.expanded #content { display: block; }
    #content { display: none; }

    /* Search and Headers */
    .search-box { max-width: 600px; margin: 0 auto 20px; }
    .search-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); }
    .notes-section-header { text-transform: uppercase; font-size: 12px; color: #888; margin: 30px 0 10px; }

    /* Masonry Grid */
    .notes-container {
        column-count: 4;
        column-gap: 15px;
    }
    @media (max-width: 1200px) { .notes-container { column-count: 3; } }
    @media (max-width: 900px) { .notes-container { column-count: 2; } }
    @media (max-width: 600px) { .notes-container { column-count: 1; } }

    /* Note Card */
    .note {
        display: inline-block;
        width: 100%;
        margin-bottom: 15px;
        background: var(--note-default-bg);
        border-radius: 10px;
        box-shadow: 0 2px 8px var(--shadow-color);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: box-shadow 0.2s;
    }
    .note:hover { box-shadow: 0 4px 15px var(--shadow-color); }
    .note-content { padding: 15px; }
    .note h3 { margin-bottom: 10px; font-size: 16px; }
    .note p { white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; }
    
    .note-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; opacity: 0; transition: opacity 0.2s; }
    .note:hover .note-footer { opacity: 1; }
    .note-footer .timestamp { font-size: 11px; color: #888; }
    .note-footer .actions button { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; color: #888; }
    
    /* Note Colors */
    .note[data-color="red"] { background-color: #f28b82; border-color: #f28b82; }
    .note[data-color="blue"] { background-color: #aecbfa; border-color: #aecbfa; }
    .note[data-color="green"] { background-color: #ccff90; border-color: #ccff90; }
    .note[data-color="yellow"] { background-color: #fff475; border-color: #fff475; }
    .note[data-color="gray"] { background-color: #e8eaed; border-color: #e8eaed; }
    /* use theme text color so colored notes remain readable in dark/light themes */
    .note[data-color] h3, .note[data-color] p, .note[data-color] .timestamp, .note[data-color] .actions button { color: var(--text-color); }

    /* Modal for Editing */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content {
        width: 90%; max-width: 700px;
        max-height: 80vh;
        display: flex; flex-direction: column;
    }
    .modal-content .note { width: 100%; margin: 0; }
    .modal-content .note-footer { opacity: 1; }
    .modal-content .edit-area { padding: 15px; flex-grow: 1; }
    .modal-content input, .modal-content textarea { width: 100%; border: none; background: transparent; color: var(--text-color); font-size: 16px; outline: none; resize: none; }
    .modal-content input { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
    .modal-content textarea { height: 100%; line-height: 1.5; }
    
    /* Animation */
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .note { animation: scaleIn 0.3s ease-out; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h1>üêù ShareHive - Notes</h1>
    <button class="toggle-btn" onclick="toggleTheme()">üåô</button>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar content remains the same -->
      <h2>Menu</h2>
      <a href="index.html">üè† Dashboard</a>
      <a href="notes.html"><b>üìù Notes</b></a>
      <a href="bookmarks.html">üîñ Bookmarks</a>
      <a href="videos.html">üé¨ Video Links</a>
      <a href="todo.html">‚úÖ To-Do List</a>
      <a href="expense.html">üí∞ Expense Tracker</a>
      <a href="planner.html">üìÖ Planner</a>
      <a href="wiki.html">üìñ Wiki</a>
      <a href="uploads.html">üìÇ Upload Files</a>
      <a href="projects.html">üìå Projects</a>
      <a href="watchlist.html">üé• Watchlist</a>
      <a href="courses.html">üìö Courses</a>
      <a href="profile.html">üë§ Profile</a>
      <a href="settings.html">‚öôÔ∏è Settings</a>
      <hr>
      <a href="about.html">‚ÑπÔ∏è About</a>
      <a href="help.html">‚ùì Help</a>
      <a href="faq.html">‚ùî FAQ</a>
      <a href="blog.html">üì∞ Blog</a>
      <a href="contact.html">‚úâÔ∏è Contact</a>
      <a href="join.html">ü§ù Join Us</a>
      <a href="report.html">üêû Report</a>
      <a href="privacy.html">üìú Privacy & Policy</a>
      <a href="community.html">üåç Community</a>
    </div>

    <!-- Main -->
    <div class="main">
      <div class="add-note-container" id="addNoteContainer">
        <div class="add-note-form" id="addNoteForm">
          <input id="title" type="text" placeholder="Take a note...">
          <textarea id="content" rows="4" placeholder="Note content..."></textarea>
          <div class="form-footer">
            <button id="saveBtn">Save</button>
          </div>
        </div>
      </div>

      <div class="search-box">
        <input id="search" type="text" placeholder="Search notes...">
      </div>

      <div id="pinned-section" style="display: none;">
        <div class="notes-section-header">Pinned</div>
        <div class="notes-container" id="pinned-notes-container"></div>
      </div>
      
      <div id="others-section" style="display: none;">
        <div class="notes-section-header">Others</div>
        <div class="notes-container" id="notes-container"></div>
      </div>
    </div>
  </div>

  <!-- Edit Note Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <div class="note" id="modalNoteCard">
        <div class="edit-area">
          <input id="modalTitle" type="text">
          <textarea id="modalContent"></textarea>
        </div>
        <div class="note-footer">
          <span class="timestamp" id="modalTimestamp"></span>
          <div class="actions" id="modalActions"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üåô Dark Mode
    const toggleBtn = document.querySelector('.toggle-btn');
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        toggleBtn.textContent = '‚òÄÔ∏è';
    }
 // üì¶ IndexedDB (v21 unified)
    let db;
    const stores = ["notes","bookmarks","videos","todos","expenses","planner","wiki","uploads","projects","watchlist","courses","profile","community"];
    const request = indexedDB.open("ShareHiveDB", 21);

    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("notes")) {
        db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => { db = e.target.result; displayNotes(); };
    request.onerror = e => console.error("DB error:", e.target.error);

    // --- Main Form Logic ---
    const addNoteForm = document.getElementById('addNoteForm');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');

    addNoteForm.addEventListener('click', () => addNoteForm.classList.add('expanded'));
    
    document.addEventListener('click', (e) => {
        if (!addNoteForm.contains(e.target)) {
            if (addNoteForm.classList.contains('expanded')) {
                saveNewNote();
            }
        }
    });

    document.getElementById('saveBtn').onclick = saveNewNote;

    function saveNewNote() {
        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        if (title || content) {
            const now = new Date().toISOString();
            const note = { title, content, pinned: false, color: 'default', createdAt: now, updatedAt: now };
            const tx = db.transaction("notes", "readwrite");
            tx.objectStore("notes").add(note);
            tx.oncomplete = () => {
                titleInput.value = "";
                contentInput.value = "";
                displayNotes();
            };
        }
        addNoteForm.classList.remove('expanded');
    }

    // --- Display & Filtering ---
    async function displayNotes() {
        const tx = db.transaction("notes", "readonly");
        const allNotes = await new Promise(res => tx.objectStore("notes").getAll().onsuccess = e => res(e.target.result));
        
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const filteredNotes = searchTerm 
            ? allNotes.filter(n => (n.title.toLowerCase().includes(searchTerm) || n.content.toLowerCase().includes(searchTerm)))
            : allNotes;

        const pinned = filteredNotes.filter(n => n.pinned).sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        const others = filteredNotes.filter(n => !n.pinned).sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));

        renderNotes('pinned-notes-container', pinned);
        renderNotes('notes-container', others);

        document.getElementById('pinned-section').style.display = pinned.length > 0 ? 'block' : 'none';
        document.getElementById('others-section').style.display = others.length > 0 ? 'block' : 'none';
    }

    function renderNotes(containerId, notes) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        notes.forEach(note => container.appendChild(createNoteElement(note)));
    }

    function createNoteElement(note) {
        const div = document.createElement('div');
        div.className = 'note';
        div.dataset.id = note.id;
        div.dataset.color = note.color || 'default';
        // open editor when clicking card
        div.addEventListener('click', () => openEditModal(note.id));

        const content = document.createElement('div');
        content.className = 'note-content';
        const h3 = document.createElement('h3');
        h3.textContent = note.title || 'Untitled';
        const p = document.createElement('p');
        p.textContent = note.content || '';
        content.appendChild(h3);
        content.appendChild(p);

        const footer = document.createElement('div');
        footer.className = 'note-footer';
        const ts = document.createElement('span');
        ts.className = 'timestamp';
        ts.textContent = `Edited ${formatRelativeTime(note.updatedAt)}`;

        const actions = document.createElement('div');
        actions.className = 'actions';

        const pinBtn = document.createElement('button');
        pinBtn.title = note.pinned ? 'Unpin' : 'Pin';
        pinBtn.textContent = note.pinned ? 'üìå' : 'üìç';
        pinBtn.addEventListener('click', (ev) => { ev.stopPropagation(); togglePin(Number(note.id)); });

        const delBtn = document.createElement('button');
        delBtn.title = 'Delete';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.addEventListener('click', (ev) => { ev.stopPropagation(); deleteNote(note.id); });

        actions.appendChild(pinBtn);
        actions.appendChild(delBtn);
        footer.appendChild(ts);
        footer.appendChild(actions);

        div.appendChild(content);
        div.appendChild(footer);
        return div;
    }
    
    // --- Edit Modal Logic ---
    const editModal = document.getElementById('editModal');
    let currentEditId = null;

    async function openEditModal(id) {
        const note = await getNoteById(id);
        if (!note) return;
        currentEditId = id;

        document.getElementById('modalTitle').value = note.title;
        document.getElementById('modalContent').value = note.content;
        document.getElementById('modalTimestamp').textContent = `Edited ${formatRelativeTime(note.updatedAt)}`;
        document.getElementById('modalNoteCard').dataset.color = note.color || 'default';
        
        // Actions (use event listeners to avoid inline handler scope issues)
        const actionsContainer = document.getElementById('modalActions');
        actionsContainer.innerHTML = '';
        const pinBtn = document.createElement('button');
        pinBtn.title = note.pinned ? 'Unpin' : 'Pin';
        pinBtn.textContent = note.pinned ? 'üìå' : 'üìç';
        pinBtn.addEventListener('click', () => togglePin(Number(id), true));

        const delBtn = document.createElement('button');
        delBtn.title = 'Delete';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.addEventListener('click', () => deleteNote(Number(id), true));

        const saveBtn = document.createElement('button');
        saveBtn.title = 'Save & Close';
        saveBtn.textContent = 'Done';
        saveBtn.addEventListener('click', () => closeEditModal(true));

        actionsContainer.appendChild(pinBtn);
        actionsContainer.appendChild(delBtn);
        actionsContainer.appendChild(saveBtn);
        
        editModal.style.display = 'flex';
    }

    function closeEditModal(save = false) {
        if (save) {
            const title = document.getElementById('modalTitle').value.trim();
            const content = document.getElementById('modalContent').value.trim();
            updateNote(currentEditId, { title, content });
        }
        editModal.style.display = 'none';
        currentEditId = null;
    }
    
    editModal.onclick = (e) => { if (e.target === editModal) closeEditModal(true); };

    // --- CRUD & Actions ---
    function deleteNote(id, fromModal = false) {
        id = Number(id);
        if (confirm('Are you sure you want to delete this note?')) {
            const tx = db.transaction("notes", "readwrite");
            tx.objectStore("notes").delete(id);
            tx.oncomplete = () => {
                if (fromModal) editModal.style.display = 'none';
                displayNotes();
            };
        }
    }

    function togglePin(id, fromModal = false) {
        updateNote(id, null, (note) => ({ pinned: !note.pinned }), fromModal);
    }
    
    function updateNote(id, data, transformFn, fromModal = false) {
        id = Number(id);
        const tx = db.transaction("notes", "readwrite");
        const store = tx.objectStore("notes");
        const req = store.get(id);
        req.onsuccess = (e) => {
            const note = e.target.result;
            if (!note) return; // nothing to update
            let updatedData = { ...note };
            if (data) Object.assign(updatedData, data);
            if (transformFn) Object.assign(updatedData, transformFn(note));
            updatedData.updatedAt = new Date().toISOString();
            store.put(updatedData);
        };
        req.onerror = () => { console.error('Failed to read note for update', id); };

        tx.oncomplete = () => {
            if (fromModal) {
                if (editModal.style.display === 'flex') {
                    openEditModal(id);
                } else {
                    displayNotes();
                }
            } else {
                displayNotes();
            }
        };
    }
    
    async function getNoteById(id) {
        id = Number(id);
        const tx = db.transaction("notes", "readonly");
        return new Promise(res => {
            tx.objectStore("notes").get(id).onsuccess = e => res(e.target.result);
        });
    }
    
    // --- Utils ---
    function formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.round((now - date) / 1000);
        const minutes = Math.round(seconds / 60);
        const hours = Math.round(minutes / 60);
        const days = Math.round(hours / 24);
        
        if (seconds < 60) return "just now";
        if (minutes < 60) return `${minutes} min ago`;
        if (hours < 24) return `${hours} hr ago`;
        if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
        return date.toLocaleDateString();
    }

    // --- Event Listeners ---
    document.getElementById('search').addEventListener('input', displayNotes);

  </script>
</body>
</html>