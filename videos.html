<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="./db.js"></script>
  <title>ShareHive - Video Links</title>
  <style>
    /* --- Base & Theme (Unchanged) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --primary-color: #0077ff;
      --sidebar-bg: #ffffff;
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0,0,0,0.07);
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --sidebar-bg: #2c2c2c;
      --card-bg: #333333;
      --border-color: #444;
      --shadow-color: rgba(0,0,0,0.25);
    }

    /* --- Navbar & Sidebar (Unchanged) --- */
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--primary-color); color: white; }
    .navbar h1 { font-size: 20px; }
    .toggle-btn { background: white; border: none; color: var(--primary-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .container { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 220px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); }
    .sidebar h2 { font-size: 16px; margin-bottom: 10px; }
    .sidebar a { display: block; text-decoration: none; color: var(--text-color); padding: 8px 10px; border-radius: 5px; margin-bottom: 5px; }
    .sidebar a:hover { background: var(--primary-color); color: white; }

    /* --- Main Content Area (Modernized) --- */
    .main { flex: 1; padding: 25px; overflow-y: auto; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .main-header h2 { font-size: 24px; margin: 0; }
    .add-video-btn {
      padding: 10px 20px; border: none; background: var(--primary-color);
      color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
    }

    .filters-toolbar {
        display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;
    }
    .filters-toolbar input, .filters-toolbar select {
        padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
        background: var(--card-bg); color: var(--text-color); font-size: 14px;
    }
    .search-box { flex-grow: 1; }

    /* --- Video Grid & Cards (Modernized) --- */
    .videos-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
    .video-card {
        background: var(--card-bg); border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow-color);
        overflow: hidden;
        display: flex; flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .video-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px var(--shadow-color); }
    
    .thumbnail {
        aspect-ratio: 16 / 9;
        background-color: #eee;
        background-size: cover;
        background-position: center;
        position: relative;
        cursor: pointer;
    }
    body.dark .thumbnail { background-color: #444; }
    .play-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.3);
        display: grid; place-items: center;
        font-size: 48px; color: white;
        opacity: 0; transition: opacity 0.2s;
    }
    .thumbnail:hover .play-overlay { opacity: 1; }

    .card-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .card-content h3 { font-size: 16px; margin-bottom: 8px; line-height: 1.4; }
    .domain-info { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #888; margin-bottom: 10px; }
    body.dark .domain-info { color: #aaa; }
    .domain-info img { width: 16px; height: 16px; }
    
    .tags-container { margin-top: auto; display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { font-size: 11px; background: #eee; color: #555; padding: 3px 8px; border-radius: 12px; }
    body.dark .tag { background: #444; color: #ccc; }
    
    .card-footer { display: flex; justify-content: flex-end; padding: 0 10px 10px; gap: 5px; }
    .card-footer button { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; color: #888; }
    body.dark .card-footer button { color: #aaa; }

    /* Empty State */
    .empty-state { text-align: center; padding: 50px; background: var(--card-bg); border-radius: 12px; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal { background: var(--bg-color); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; }
    .modal-header .close-btn { font-size: 24px; background: none; border: none; cursor: pointer; color: var(--text-color); }
    .form { display: flex; flex-direction: column; gap: 15px; }
    .form input { width: 100%; padding: 12px; font-size: 14px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); }
    .form button { padding: 12px; border: none; background: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }

    /* Animations */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .video-card { animation: fadeInUp 0.5s ease-out forwards; }
    .video-card.deleting { transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: scale(0.95); }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h1>üêù ShareHive - Video Links</h1>
    <button class="toggle-btn" onclick="toggleTheme()">üåô</button>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar content remains the same -->
      <h2>Menu</h2>
      <a href="index.html">üè† Dashboard</a>
      <a href="notes.html">üìù Notes</a>
      <a href="bookmarks.html">üîñ Bookmarks</a>
      <a href="videos.html"><b>üé¨ Video Links</b></a>
      <a href="todo.html">‚úÖ To-Do List</a>
      <a href="expense.html">üí∞ Expense Tracker</a>
      <a href="planner.html">üìÖ Planner</a>
      <a href="wiki.html">üìñ Wiki</a>
      <a href="uploads.html">üìÇ Upload Files</a>
      <a href="projects.html">üìå Projects</a>
      <a href="watchlist.html">üé• Watchlist</a>
      <a href="courses.html">üìö Courses</a>
      <a href="profile.html">üë§ Profile</a>
      <a href="settings.html">‚öôÔ∏è Settings</a>
      <hr>
      <a href="about.html">‚ÑπÔ∏è About</a>
      <a href="help.html">‚ùì Help</a>
      <a href="faq.html">‚ùî FAQ</a>
      <a href="blog.html">üì∞ Blog</a>
      <a href="contact.html">‚úâÔ∏è Contact</a>
      <a href="join.html">ü§ù Join Us</a>
      <a href="report.html">üêû Report</a>
      <a href="privacy.html">üìú Privacy & Policy</a>
      <a href="community.html">üåç Community</a>
    </div>

    <!-- Main -->
    <div class="main">
      <div class="main-header">
        <h2>My Video Library</h2>
        <button class="add-video-btn" id="addVideoBtn">‚ûï Add Video</button>
      </div>

      <div class="filters-toolbar">
        <input class="search-box" id="search" type="text" placeholder="Search by title...">
        <select id="tagFilter"></select>
        <select id="sortOrder">
          <option value="newest">Sort by Newest</option>
          <option value="oldest">Sort by Oldest</option>
          <option value="az">Sort by Title (A-Z)</option>
          <option value="za">Sort by Title (Z-A)</option>
        </select>
      </div>

      <div class="videos-container" id="videosContainer"></div>
    </div>
  </div>

  <!-- Add/Edit Video Modal -->
  <div class="modal-overlay" id="videoModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Video</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="form">
        <input id="title" type="text" placeholder="Video Title">
        <input id="url" type="url" placeholder="Video URL (e.g., YouTube, Vimeo)">
        <input id="tags" type="text" placeholder="Tags (comma-separated, e.g., tech, tutorial)">
        <button id="saveBtn">Save Video</button>
      </div>
    </div>
  </div>

  <script>
    // üåô Dark Mode
    const toggleBtn = document.querySelector('.toggle-btn');
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        toggleBtn.textContent = '‚òÄÔ∏è';
    }

     // üì¶ IndexedDB (v21 unified)
    let db;
    const stores = ["notes","bookmarks","videos","todos","expenses","planner","wiki","uploads","projects","watchlist","courses","profile","community"];
    const request = indexedDB.open("ShareHiveDB", 22);


    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("videos")) {
        // Add `tags`, `createdAt`, `thumbnail`, `domain`
        db.createObjectStore("videos", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => { db = e.target.result; displayVideos(); };
    request.onerror = e => console.error("DB error:", e.target.error);

    // --- Modal Handling ---
    const modal = document.getElementById('videoModal');
    const openModalBtn = document.getElementById('addVideoBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalTitle = document.getElementById('modalTitle');
    const saveBtn = document.getElementById('saveBtn');
    const form = {
      title: document.getElementById('title'),
      url: document.getElementById('url'),
      tags: document.getElementById('tags'),
    };
    
    function openModal(video = null) {
        if (video) { // Editing
            modalTitle.textContent = 'Edit Video';
            saveBtn.textContent = 'Update Video';
            saveBtn.dataset.editId = video.id;
            form.title.value = video.title;
            form.url.value = video.url;
            form.tags.value = video.tags ? video.tags.join(', ') : '';
        } else { // Adding new
            modalTitle.textContent = 'Add New Video';
            saveBtn.textContent = 'Save Video';
            delete saveBtn.dataset.editId;
            form.title.value = '';
            form.url.value = '';
            form.tags.value = '';
        }
        modal.style.display = 'flex';
    }
    function closeModal() { modal.style.display = 'none'; }
    openModalBtn.onclick = () => openModal();
    closeModalBtn.onclick = closeModal;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };

    // --- Video Metadata ---
    function getVideoMetadata(url) {
        try {
            const urlObj = new URL(url);
            const domain = urlObj.hostname.replace('www.', '');
            let thumbnail = `https://s2.googleusercontent.com/s2/favicons?domain=${domain}&sz=64`; // Favicon fallback
            
            // YouTube
            if (domain.includes('youtube.com') || domain.includes('youtu.be')) {
                const videoId = urlObj.searchParams.get('v') || urlObj.pathname.split('/').pop();
                if (videoId) thumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            }
            // Vimeo
            else if (domain.includes('vimeo.com')) {
                const videoId = urlObj.pathname.split('/').pop();
                // Vimeo requires an API call for thumbnails, so we'll stick to favicon for simplicity here.
                // For a production app, you'd fetch `https://vimeo.com/api/v2/video/${videoId}.json`
            }
            return { thumbnail, domain };
        } catch (e) {
            return { thumbnail: '', domain: 'Invalid URL' };
        }
    }

    // --- Display & Filtering Logic ---
    async function displayVideos() {
        const tx = db.transaction("videos", "readonly");
        const allVideos = await new Promise(res => tx.objectStore("videos").getAll().onsuccess = e => res(e.target.result));
        
        updateTagFilter(allVideos);
        
        // 1. Filter
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const tagFilter = document.getElementById('tagFilter').value;
        let filteredVideos = allVideos.filter(v => {
            const titleMatch = v.title.toLowerCase().includes(searchTerm);
            const tagMatch = tagFilter === 'all' || (v.tags && v.tags.includes(tagFilter));
            return titleMatch && tagMatch;
        });

        // 2. Sort
        const sortOrder = document.getElementById('sortOrder').value;
        filteredVideos.sort((a, b) => {
            if (sortOrder === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
            if (sortOrder === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
            if (sortOrder === 'az') return a.title.localeCompare(b.title);
            if (sortOrder === 'za') return b.title.localeCompare(a.title);
        });

        // 3. Render
        const container = document.getElementById('videosContainer');
        container.innerHTML = '';
        if (filteredVideos.length === 0) {
            container.innerHTML = `<div class="empty-state"><h3>No videos found.</h3><p>Try adding a new video or adjusting your filters.</p></div>`;
        } else {
            filteredVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.dataset.id = video.id;
                card.innerHTML = `
                    <a href="${video.url}" target="_blank" class="thumbnail" style="background-image: url('${video.thumbnail}')">
                        <div class="play-overlay">‚ñ∂</div>
                    </a>
                    <div class="card-content">
                        <h3>${video.title}</h3>
                        <div class="domain-info">
                            <img src="https://s2.googleusercontent.com/s2/favicons?domain=${video.domain}&sz=16" alt="">
                            <span>${video.domain}</span>
                        </div>
                        <div class="tags-container">
                            ${(video.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="card-footer">
                        <button onclick="editVideo(${video.id})" title="Edit">‚úèÔ∏è</button>
                        <button onclick="deleteVideo(${video.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    }
    
    function updateTagFilter(videos) {
        const allTags = new Set(videos.flatMap(v => v.tags || []));
        const filterSelect = document.getElementById('tagFilter');
        const currentVal = filterSelect.value;
        filterSelect.innerHTML = '<option value="all">Filter by Tag (All)</option>';
        allTags.forEach(tag => {
            const selected = tag === currentVal ? 'selected' : '';
            filterSelect.innerHTML += `<option value="${tag}" ${selected}>${tag}</option>`;
        });
    }

    // --- CRUD ---
    saveBtn.onclick = () => {
        const title = form.title.value.trim();
        const url = form.url.value.trim();
        if (!title || !url) { alert("Title and URL are required."); return; }
        
        const { thumbnail, domain } = getVideoMetadata(url);
        const tags = form.tags.value.split(',').map(t => t.trim()).filter(Boolean);
        const editId = saveBtn.dataset.editId;
        
        const tx = db.transaction("videos", "readwrite");
        const store = tx.objectStore("videos");

        if (editId) { // Update
            const req = store.get(Number(editId));
            req.onsuccess = () => {
                const video = req.result;
                Object.assign(video, { title, url, tags, thumbnail, domain });
                store.put(video);
            };
        } else { // Add new
            const videoData = { title, url, tags, thumbnail, domain, createdAt: new Date().toISOString() };
            store.add(videoData);
        }
        
        tx.oncomplete = () => { closeModal(); displayVideos(); };
    };

    function editVideo(id) {
        const tx = db.transaction("videos", "readonly");
        tx.objectStore("videos").get(id).onsuccess = e => openModal(e.target.result);
    }
    
    function deleteVideo(id) {
        const card = document.querySelector(`.video-card[data-id='${id}']`);
        if (card && confirm("Are you sure you want to delete this video?")) {
            card.classList.add('deleting');
            setTimeout(() => {
                const tx = db.transaction("videos", "readwrite");
                tx.objectStore("videos").delete(id);
                tx.oncomplete = displayVideos;
            }, 300); // Wait for animation
        }
    }

    // --- Event Listeners ---
    document.getElementById('search').addEventListener('input', displayVideos);
    document.getElementById('tagFilter').addEventListener('change', displayVideos);
    document.getElementById('sortOrder').addEventListener('change', displayVideos);

  </script>
</body>
</html>