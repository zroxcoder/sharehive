<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShareHive - Projects</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
    :root {
      --bg-color: #f4f7fa; --text-color: #222;
      --primary-color: #0077ff; --secondary-color: #00c896; --sidebar-bg: #ffffff; --card-bg: #ffffff;
      --border-color: #e0e0e0; --success-color: #28a745; --warning-color: #ffc107;
      --danger-color: #dc3545; --info-color: #17a2b8;
    }
    body.dark {
      --bg-color: #1e1e1e; --text-color: #f0f0f0; --sidebar-bg: #2c2c2c;
      --card-bg: #333333; --border-color: #444;
    }

    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color), #0056cc); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar h1 { font-size: 20px; }
    .toggle-btn { background: white; border: none; color: var(--primary-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .toggle-btn:hover { transform: scale(1.05); box-shadow: 0 3px 8px rgba(0,0,0,0.3); }

    .container { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 220px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); }
    .sidebar a { display: block; padding: 8px 10px; margin-bottom: 5px; text-decoration: none; color: var(--text-color); border-radius: 5px; transition: all 0.3s ease; }
    .sidebar a:hover { background: var(--primary-color); color: white; transform: translateX(5px); }

    .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-color); }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); }
    .page-header h2 { font-size: 32px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
    
    .btn { padding: 12px 30px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(0,119,255,0.3); }
    .btn-primary:hover { background: #0056cc; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,119,255,0.4); }

    .form-card { background: var(--card-bg); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 2px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: none; }
    .form-card.show { display: block; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .form-card h3 { font-size: 24px; margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-color); color: var(--text-color); font-size: 15px; transition: all 0.3s ease; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,119,255,0.1); }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-actions { display: flex; gap: 15px; margin-top: 10px; }
    .btn-secondary { background: var(--border-color); color: var(--text-color); }
    .btn-secondary:hover { background: #ccc; }

    .view-switcher { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
    .view-switcher .tabs { display: flex; border: 2px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .tab-btn { padding: 10px 20px; background: var(--card-bg); border: none; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-color); transition: all 0.3s ease; }
    .tab-btn:not(:last-child) { border-right: 2px solid var(--border-color); }
    .tab-btn:hover { background: var(--bg-color); }
    .tab-btn.active { background: var(--primary-color); color: white; }
    
    .search-container { flex: 1; position: relative; }
    .search-box { width: 100%; padding: 12px 45px 12px 15px; font-size: 15px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--card-bg); color: var(--text-color); }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

    .view-container { display: none; }
    .view-container.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* List View */
    .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .project-card { background: var(--card-bg); border-radius: 15px; border: 2px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; animation: fadeInUp 0.5s ease-out backwards; display: flex; flex-direction: column; }
    .project-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); border-color: var(--primary-color); }
    .project-card.pinned { border-color: var(--warning-color); }
    .project-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
    .project-title { font-size: 20px; margin-bottom: 8px; color: var(--text-color); }
    .project-meta { display: flex; gap: 10px; font-size: 12px; opacity: 0.7; }
    .badge { padding: 3px 8px; border-radius: 10px; }
    .badge.todo { background: var(--info-color); color: white; }
    .badge.progress { background: var(--primary-color); color: white; }
    .badge.done { background: var(--success-color); color: white; }
    
    .project-body { padding: 20px; flex: 1; }
    .project-desc { font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 15px; }
    .progress-section { margin-bottom: 15px; }
    .progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
    .progress-bar span { display: block; height: 100%; background: var(--primary-color); transition: width 0.3s ease; }
    .progress-text { font-size: 12px; font-weight: 600; margin-top: 5px; opacity: 0.7; }
    
    .subtasks-section h4 { margin-bottom: 10px; font-size: 15px; }
    .subtasks-list { max-height: 120px; overflow-y: auto; padding-right: 10px; }
    .subtask-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
    .subtask-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .subtask-item label { flex: 1; cursor: pointer; }
    .subtask-item label.completed { text-decoration: line-through; opacity: 0.6; }

    .project-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px; }
    .action-btn { padding: 6px 12px; border: none; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
    .btn-edit { background: var(--info-color); color: white; }
    .btn-delete { background: var(--danger-color); color: white; }
    .btn-pin { background: var(--warning-color); color: #333; }
    .btn-subtask { background: var(--secondary-color); color: white; }
    .action-btn:hover { opacity: 0.8; transform: scale(1.05); }

    /* Kanban View */
    .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: start; }
    .kanban-column { background: var(--bg-color); padding: 15px; border-radius: 12px; border: 2px dashed var(--border-color); }
    .kanban-column h3 { font-size: 18px; text-align: center; margin-bottom: 15px; padding: 8px; border-radius: 8px; background: var(--card-bg); border: 2px solid var(--border-color); }
    .kanban-column .items { min-height: 300px; }
    .kanban-item { background: var(--card-bg); border-radius: 10px; border: 2px solid var(--border-color); padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: grab; }
    .kanban-item h4 { font-size: 16px; margin-bottom: 5px; }
    .kanban-item .progress-bar { margin: 8px 0; }
    .kanban-item.dragging { opacity: 0.5; }

    /* Gantt View */
    .gantt-chart { overflow-x: auto; background: var(--card-bg); padding: 20px; border-radius: 15px; border: 2px solid var(--border-color); }
    .gantt-container { min-width: 800px; }
    .gantt-header { display: grid; grid-template-columns: 200px 1fr; font-weight: bold; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
    .gantt-row { display: grid; grid-template-columns: 200px 1fr; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .gantt-row:last-child { border-bottom: none; }
    .gantt-bar-container { position: relative; height: 30px; }
    .gantt-bar { position: absolute; height: 100%; background: var(--primary-color); border-radius: 5px; display: flex; align-items: center; padding-left: 10px; color: white; font-size: 12px; white-space: nowrap; overflow: hidden; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; }
    .modal-content h3 { margin-bottom: 15px; }
    .modal-content input { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    
    @media (max-width: 968px) {
      .form-grid, .kanban-board { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; }
      .main { padding: 20px; }
      .view-switcher { flex-direction: column; align-items: stretch; }
      .search-container { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üêù ShareHive - Projects</h1>
    <button class="toggle-btn" onclick="toggleTheme()">üåô</button>
  </div>
  
  <div class="modal" id="subtaskModal">
    <div class="modal-content">
      <h3>Add New Subtask</h3>
      <input type="text" id="subtaskInput" placeholder="Enter subtask name...">
      <div class="form-actions">
        <button class="btn btn-primary" id="saveSubtaskBtn">Save Subtask</button>
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h2>Menu</h2>
      <a href="index.html">üè† Dashboard</a>
      <a href="notes.html">üìù Notes</a>
      <a href="bookmarks.html">üîñ Bookmarks</a>
      <a href="videos.html">üé¨ Videos</a>
      <a href="todo.html">‚úÖ To-Do</a>
      <a href="expense.html">üí∞ Expenses</a>
      <a href="planner.html">üìÖ Planner</a>
      <a href="wiki.html">üìñ Wiki</a>
      <a href="uploads.html">üìÇ Uploads</a>
      <a href="projects.html"><b>üìå Projects</b></a>
      <a href="watchlist.html">üé• Watchlist</a>
      <a href="courses.html">üìö Courses</a>
      <a href="profile.html">üë§ Profile</a>
      <a href="settings.html">‚öôÔ∏è Settings</a>
      <hr>
      <a href="about.html">‚ÑπÔ∏è About</a>
      <a href="help.html">‚ùì Help</a>
      <a href="faq.html">‚ùî FAQ</a>
      <a href="blog.html">üì∞ Blog</a>
      <a href="contact.html">‚úâÔ∏è Contact</a>
      <a href="join.html">ü§ù Join Us</a>
      <a href="report.html">üêû Report</a>
      <a href="privacy.html">üìú Privacy</a>
      <a href="community.html">üåç Community</a>
    </div>

    <div class="main">
      <div class="page-header">
        <h2>üìå My Projects</h2>
        <button class="btn btn-primary" onclick="toggleForm()">
          <span>‚ûï</span>
          <span>New Project</span>
        </button>
      </div>

      <div class="form-card" id="addFormCard">
        <h3><span id="formIcon">‚ûï</span> <span id="formTitle">Add New Project</span></h3>
        <form id="projectForm">
          <input type="hidden" id="editId">
          <div class="form-group full-width">
            <label>Project Title *</label>
            <input type="text" id="title" placeholder="e.g., Build a personal website" required>
          </div>
          <div class="form-group full-width">
            <label>Description</label>
            <textarea id="desc" placeholder="A brief summary of the project..."></textarea>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="start">
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" id="due">
            </div>
          </div>
          <div class="form-group full-width">
            <label>Status</label>
            <select id="status">
              <option value="todo">To-Do</option>
              <option value="progress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="saveBtn">Save Project</button>
            <button type="button" class="btn btn-secondary" onclick="toggleForm()">Cancel</button>
          </div>
        </form>
      </div>
      
      <div class="view-switcher">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchView('list')">üìÑ List</button>
          <button class="tab-btn" onclick="switchView('kanban')">üìã Kanban</button>
          <button class="tab-btn" onclick="switchView('gantt')">üìä Gantt</button>
        </div>
        <div class="search-container">
          <input type="text" id="search" class="search-box" placeholder="Search projects...">
          <span class="search-icon">üîç</span>
        </div>
      </div>
      
      <div id="listView" class="view-container active">
        <div class="projects-grid" id="projectsGrid"></div>
      </div>
      
      <div id="kanbanView" class="view-container">
        <div class="kanban-board">
          <div class="kanban-column" id="col-todo"><h3>To-Do</h3><div class="items"></div></div>
          <div class="kanban-column" id="col-progress"><h3>In Progress</h3><div class="items"></div></div>
          <div class="kanban-column" id="col-done"><h3>Done</h3><div class="items"></div></div>
        </div>
      </div>

      <div id="ganttView" class="view-container">
        <div class="gantt-chart">
          <div class="gantt-container" id="ganttContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }
    if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");

     // üì¶ IndexedDB (v21 unified)
    let db;
    const stores = ["notes","bookmarks","videos","todos","expenses","planner","wiki","uploads","projects","watchlist","courses","profile","community"];
    const request = indexedDB.open("ShareHiveDB", 22);


    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("projects")) {
        db.createObjectStore("projects", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => { 
      db = e.target.result; 
      displayProjects();
    };
    request.onerror = e => console.error("DB error:", e.target.error);

    let editingProjectId = null;

    function toggleForm() {
      const formCard = document.getElementById('addFormCard');
      const isVisible = formCard.classList.toggle('show');
      if (!isVisible) clearForm();
    }
    
    document.getElementById("projectForm").addEventListener('submit', (e) => {
      e.preventDefault();
      const project = {
        title: document.getElementById("title").value.trim(),
        desc: document.getElementById("desc").value.trim(),
        start: document.getElementById("start").value,
        due: document.getElementById("due").value,
        status: document.getElementById("status").value,
      };
      if(!project.title) return;

      const tx = db.transaction("projects", "readwrite");
      const store = tx.objectStore("projects");
      
      if(editingProjectId){ 
        store.get(editingProjectId).onsuccess = (e) => {
          const existing = e.target.result;
          const updatedProject = { ...existing, ...project, id: editingProjectId };
          store.put(updatedProject);
        };
      } else {
        project.pinned = false;
        project.subtasks = [];
        store.add(project);
      }

      tx.oncomplete = () => { clearForm(); toggleForm(); displayProjects(); };
    });

    function clearForm() {
      document.getElementById("projectForm").reset();
      editingProjectId = null;
      document.getElementById("formTitle").textContent = "Add New Project";
      document.getElementById("formIcon").textContent = "‚ûï";
      document.getElementById("saveBtn").textContent = "Save Project";
    }

    function displayProjects() {
      const tx = db.transaction("projects", "readonly");
      tx.objectStore("projects").getAll().onsuccess = e => {
        let projects = e.target.result;
        const search = document.getElementById("search").value.toLowerCase();
        if (search) projects = projects.filter(p => p.title.toLowerCase().includes(search) || p.desc.toLowerCase().includes(search));
        projects.sort((a, b) => b.pinned - a.pinned);

        renderListView(projects);
        renderKanbanView(projects);
        renderGanttView(projects);
      };
    }

    // Render Views
    function renderListView(projects) {
      const container = document.getElementById("projectsGrid");
      container.innerHTML = projects.map(p => {
        const { done, total, progress } = calculateProgress(p.subtasks);
        return `
          <div class="project-card ${p.pinned ? 'pinned' : ''}">
            <div class="project-header">
              <h3 class="project-title">${p.title}</h3>
              <div class="project-meta">
                <span class="badge ${p.status}">${p.status.replace('-', ' ')}</span>
                <span>${p.start || ''} ‚Üí ${p.due || ''}</span>
              </div>
            </div>
            <div class="project-body">
              <p class="project-desc">${p.desc || ""}</p>
              <div class="progress-section">
                <div class="progress-bar"><span style="width:${progress}%"></span></div>
                <p class="progress-text">${done} of ${total} subtasks complete</p>
              </div>
              <div class="subtasks-section">
                <h4>Subtasks</h4>
                <div class="subtasks-list">
                  ${p.subtasks.map((s, i) => `
                    <div class="subtask-item">
                      <input type="checkbox" id="subtask-${p.id}-${i}" ${s.done ? "checked" : ""} onchange="toggleSubtask(${p.id}, ${i})">
                      <label for="subtask-${p.id}-${i}" class="${s.done ? 'completed' : ''}">${s.text}</label>
                    </div>`).join("")}
                </div>
              </div>
            </div>
            <div class="project-footer">
              <button class="action-btn btn-edit" onclick="editProject(${p.id})">‚úèÔ∏è Edit</button>
              <button class="action-btn btn-delete" onclick="deleteProject(${p.id})">üóëÔ∏è Delete</button>
              <button class="action-btn btn-pin" onclick="togglePin(${p.id})">${p.pinned ? "Unpin" : "üìå Pin"}</button>
              <button class="action-btn btn-subtask" onclick="openSubtaskModal(${p.id})">‚ûï Add Subtask</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKanbanView(projects) {
      ["todo", "progress", "done"].forEach(status => {
        document.getElementById(`col-${status}`).querySelector('.items').innerHTML = '';
      });
      projects.forEach(p => {
        const { progress } = calculateProgress(p.subtasks);
        const item = document.createElement('div');
        item.className = 'kanban-item';
        item.draggable = true;
        item.dataset.id = p.id;
        item.innerHTML = `
          <h4>${p.title}</h4>
          <div class="progress-bar"><span style="width:${progress}%"></span></div>
        `;
        item.addEventListener('dragstart', handleDragStart);
        document.getElementById(`col-${p.status}`).querySelector('.items').appendChild(item);
      });
    }

    function renderGanttView(projects) {
      const container = document.getElementById("ganttContainer");
      if (!projects.length) return;

      const projectDates = projects.filter(p => p.start && p.due)
        .map(p => [new Date(p.start), new Date(p.due)]).flat();
      if (!projectDates.length) {
        container.innerHTML = '<p>No projects with start and end dates to display.</p>';
        return;
      }
      const minDate = new Date(Math.min(...projectDates));
      const maxDate = new Date(Math.max(...projectDates));
      
      const dayWidth = 30; // pixels per day
      const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24) + 1;
      
      let ganttHTML = `
        <div class="gantt-header">
          <div>Project</div><div>Timeline</div>
        </div>`;

      projects.filter(p => p.start && p.due).forEach(p => {
        const start = new Date(p.start);
        const due = new Date(p.due);
        const offset = (start - minDate) / (1000 * 60 * 60 * 24);
        const duration = (due - start) / (1000 * 60 * 60 * 24) + 1;
        
        ganttHTML += `
          <div class="gantt-row">
            <div>${p.title}</div>
            <div class="gantt-bar-container">
              <div class="gantt-bar" style="left:${offset * dayWidth}px; width:${duration * dayWidth}px;">
                ${p.title}
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = ganttHTML;
    }

    // Actions
    function editProject(id) {
      const tx = db.transaction("projects", "readonly");
      tx.objectStore("projects").get(id).onsuccess = e => {
        const p = e.target.result;
        Object.keys(p).forEach(key => {
          const el = document.getElementById(key);
          if (el) el.value = p[key];
        });
        editingProjectId = id;
        document.getElementById("formTitle").textContent = "Edit Project";
        document.getElementById("formIcon").textContent = "‚úèÔ∏è";
        document.getElementById("saveBtn").textContent = "Update Project";
        const formCard = document.getElementById('addFormCard');
        if (!formCard.classList.contains('show')) formCard.classList.add('show');
        formCard.scrollIntoView({ behavior: 'smooth' });
      };
    }
    function deleteProject(id) {
      if (!confirm('Are you sure you want to delete this project?')) return;
      db.transaction("projects", "readwrite").objectStore("projects").delete(id).onsuccess = displayProjects;
    }
    function togglePin(id) {
      const tx = db.transaction("projects", "readwrite");
      const store = tx.objectStore("projects");
      store.get(id).onsuccess = e => {
        const p = e.target.result; p.pinned = !p.pinned; store.put(p);
      };
      tx.oncomplete = displayProjects;
    }
    
    // Subtasks
    function openSubtaskModal(projectId) {
      const modal = document.getElementById('subtaskModal');
      modal.classList.add('show');
      document.getElementById('subtaskInput').focus();
      document.getElementById('saveSubtaskBtn').onclick = () => addSubtask(projectId);
    }
    function closeModal() { document.getElementById('subtaskModal').classList.remove('show'); }
    function addSubtask(projectId) {
      const text = document.getElementById('subtaskInput').value.trim();
      if (!text) return;
      const tx = db.transaction("projects", "readwrite");
      const store = tx.objectStore("projects"); // <-- FIXED: get store from tx
      store.get(projectId).onsuccess = e => {
        const p = e.target.result;
        if (!p.subtasks) p.subtasks = [];
        p.subtasks.push({ text, done: false });
        store.put(p);
      };
      tx.oncomplete = () => {
        document.getElementById('subtaskInput').value = '';
        closeModal();
        displayProjects();
      };
    }
    function toggleSubtask(projectId, index) {
      const tx = db.transaction("projects", "readwrite");
      const store = tx.objectStore("projects");
      store.get(projectId).onsuccess = e => {
        const p = e.target.result;
        p.subtasks[index].done = !p.subtasks[index].done;
        store.put(p);
      };
      tx.oncomplete = displayProjects;
    }
    
    // Drag & Drop
    let draggedItem = null;
    function handleDragStart(e) { draggedItem = e.target; e.target.classList.add('dragging'); }
    function handleDragEnd(e) { e.target.classList.remove('dragging'); }
    document.querySelectorAll('.kanban-column').forEach(col => {
      col.addEventListener('dragover', e => e.preventDefault());
      col.addEventListener('dragend', handleDragEnd);
      col.addEventListener('drop', e => {
        e.preventDefault();
        if (draggedItem) {
          const id = Number(draggedItem.dataset.id);
          const newStatus = col.id.replace("col-", "");
          const tx = db.transaction("projects", "readwrite");
          const store = tx.objectStore("projects");
          store.get(id).onsuccess = ev => {
            const p = ev.target.result; p.status = newStatus; store.put(p);
          };
          tx.oncomplete = displayProjects;
          draggedItem = null;
        }
      });
    });

    // Helpers
    function calculateProgress(subtasks = []) {
      const total = subtasks.length;
      if (total === 0) return { done: 0, total: 0, progress: 0 };
      const done = subtasks.filter(s => s.done).length;
      const progress = Math.round((done / total) * 100);
      return { done, total, progress };
    }
    
    // View Switcher
    function switchView(view) {
      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      document.getElementById(`${view}View`).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="switchView('${view}')"]`).classList.add('active');
    }
    
    document.getElementById("search").addEventListener("input", displayProjects);
    
    // Initialize DB transaction store
    let store;
    const tx = db.transaction("projects", "readwrite");
    store = tx.objectStore("projects");
    tx.oncomplete = displayProjects;
  </script>
</body>
</html>