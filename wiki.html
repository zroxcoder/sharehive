<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShareHive - Wiki</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: 0.3s;
    }
    :root {
      --bg-color: #ffffff;
      --text-color: #222;
      --primary-color: #0077ff;
      --sidebar-bg: #f4f4f4;
      --card-bg: #f8f8f8;
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --sidebar-bg: #2c2c2c;
      --card-bg: #333333;
    }

    .navbar { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:var(--primary-color); color:white; }
    .toggle-btn { background:white; border:none; color:var(--primary-color); padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold; }

    .container { display:flex; height:calc(100vh - 50px); }
    .sidebar { width:220px; background:var(--sidebar-bg); padding:20px; overflow-y:auto; }
    .sidebar a { display:block; text-decoration:none; color:var(--text-color); padding:8px 10px; border-radius:5px; margin-bottom:5px; }
    .sidebar a:hover { background:var(--primary-color); color:white; }
    .main { flex:1; padding:20px; overflow-y:auto; }

    .form { display:flex; flex-direction:column; gap:8px; margin-bottom:20px; }
    .form input, .form textarea {
      padding:8px; border:1px solid #ccc; border-radius:5px;
      background:var(--card-bg); color:var(--text-color);
    }
    .form button { padding:8px; background:var(--primary-color); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }

    .search-sort { display:flex; gap:10px; margin-bottom:15px; }
    .wiki-entry {
      background:var(--card-bg); padding:15px; border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:15px;
    }
    .wiki-entry h3 { margin-bottom:5px; }
    .wiki-entry .meta { font-size:12px; color:gray; margin-bottom:8px; }
    .actions button { margin-right:5px; padding:5px 8px; border:none; border-radius:5px; font-size:12px; cursor:pointer; }
    .edit { background:#4caf50; color:white; }
    .delete { background:#f44336; color:white; }
    .pin { background:gold; }
    .star { background:#ff9800; color:white; }
    .collapse { background:#555; color:white; }
    .attachment { margin-top:5px; font-size:12px; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h1>🐝 ShareHive - Wiki</h1>
    <button class="toggle-btn" onclick="toggleTheme()">🌙</button>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="index.html">🏠 Dashboard</a>
      <a href="notes.html">📝 Notes</a>
      <a href="bookmarks.html">🔖 Bookmarks</a>
      <a href="videos.html">🎬 Videos</a>
      <a href="todo.html">✅ To-Do</a>
      <a href="expense.html">💰 Expenses</a>
      <a href="planner.html">📅 Planner</a>
      <a href="wiki.html">📖 Wiki</a>
      <a href="uploads.html">📂 Uploads</a>
      <a href="projects.html">📌 Projects</a>
      <a href="watchlist.html">🎥 Watchlist</a>
      <a href="courses.html">📚 Courses</a>
      <a href="profile.html">👤 Profile</a>
      <a href="settings.html">⚙️ Settings</a>
      <hr>
      <a href="about.html">ℹ️ About</a>
      <a href="help.html">❓ Help</a>
      <a href="faq.html">❔ FAQ</a>
      <a href="blog.html">📰 Blog</a>
      <a href="contact.html">✉️ Contact</a>
      <a href="join.html">🤝 Join</a>
      <a href="report.html">🐞 Report</a>
      <a href="privacy.html">📜 Privacy</a>
      <a href="community.html">🌍 Community</a>
    </div>

    <!-- Main -->
    <div class="main">
      <h2>Add Wiki Entry</h2>
      <div class="form">
        <input type="text" id="title" placeholder="Title">
        <textarea id="content" placeholder="Content (supports **bold**, *italic*, `code`, - list, [[links]])"></textarea>
        <input type="text" id="tags" placeholder="Tags (comma separated)">
        <input type="file" id="attachment">
        <button id="saveBtn">Save Wiki</button>
      </div>

      <div class="search-sort">
        <input type="text" id="search" placeholder="Search wiki...">
        <select id="sort">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="title-az">Title A–Z</option>
          <option value="title-za">Title Z–A</option>
          <option value="pinned">Pinned First</option>
          <option value="starred">Starred First</option>
        </select>
      </div>

      <h2>Your Wiki</h2>
      <div id="wiki"></div>
    </div>
  </div>

  <script>
    // 🌙 Dark Mode
    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }
    if(localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

    // 📦 IndexedDB (v21 unified)
let db;
const stores = [
  "notes",
  "bookmarks",
  "videos",
  "todos",
  "expenses",
  "planner",
  "wiki",
  "uploads",
  "projects",
  "watchlist",
  "courses",
  "profile",
  "settings",
  "community"
];

const request = indexedDB.open("ShareHiveDB", 21);

request.onupgradeneeded = e => {
  db = e.target.result;
  stores.forEach(name => {
    if (!db.objectStoreNames.contains(name)) {
      db.createObjectStore(name, { keyPath: "id", autoIncrement: true });
    }
  });
};

request.onsuccess = e => { 
  db = e.target.result; 
  displayWiki();  // ✅ call page-specific display function
};

request.onerror = e => console.error("DB error:", e.target.error);


    // 📝 Markdown Renderer
    function renderMarkdown(text){
      return text
        .replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")
        .replace(/\*(.*?)\*/g,"<i>$1</i>")
        .replace(/`(.*?)`/g,"<code>$1</code>")
        .replace(/^- (.*)$/gm,"<li>$1</li>")
        .replace(/\[\[(.*?)\]\]/g, `<a href="#" onclick="searchLink('$1')">$1</a>`);
    }

    // ➕ Save Wiki
    document.getElementById("saveBtn").onclick=()=>{
      const title=document.getElementById("title").value.trim();
      const content=document.getElementById("content").value.trim();
      const tags=document.getElementById("tags").value.split(",").map(t=>t.trim()).filter(t=>t);
      const file=document.getElementById("attachment").files[0];
      if(!title && !content) return;

      const btn=document.getElementById("saveBtn");
      const editId=btn.getAttribute("data-edit");

      const tx=db.transaction("wiki","readwrite");
      const store=tx.objectStore("wiki");

      const entry={title,content,tags,starred:false,pinned:false,date:Date.now()};

      if(file){
        const reader=new FileReader();
        reader.onload=()=>{
          entry.attachment={name:file.name,data:reader.result};
          if(editId){ entry.id=Number(editId); store.put(entry); }
          else{ store.add(entry); }
        };
        reader.readAsDataURL(file);
      } else {
        if(editId){ entry.id=Number(editId); store.put(entry); }
        else{ store.add(entry); }
      }

      tx.oncomplete=()=>{
        ["title","content","tags","attachment"].forEach(id=>{
          const el=document.getElementById(id);
          if(el.type==="file") el.value=""; else el.value="";
        });
        btn.textContent="Save Wiki"; btn.removeAttribute("data-edit");
        displayWiki();
      };
    };

    // 📖 Display Wiki
    function displayWiki(){
      const tx=db.transaction("wiki","readonly");
      const store=tx.objectStore("wiki");
      const req=store.getAll();

      req.onsuccess=()=>{
        let entries=req.result;
        const search=document.getElementById("search").value.toLowerCase();
        if(search){
          entries=entries.filter(e=>e.title.toLowerCase().includes(search)||e.content.toLowerCase().includes(search)||(e.tags||[]).some(t=>t.toLowerCase().includes(search)));
        }
        const sort=document.getElementById("sort").value;
        if(sort==="newest") entries.sort((a,b)=>b.date-a.date);
        if(sort==="oldest") entries.sort((a,b)=>a.date-b.date);
        if(sort==="title-az") entries.sort((a,b)=>a.title.localeCompare(b.title));
        if(sort==="title-za") entries.sort((a,b)=>b.title.localeCompare(a.title));
        if(sort==="pinned") entries.sort((a,b)=>b.pinned-a.pinned);
        if(sort==="starred") entries.sort((a,b)=>b.starred-a.starred);

        const container=document.getElementById("wiki");
        container.innerHTML="";
        entries.forEach(e=>{
          const div=document.createElement("div");
          div.className="wiki-entry";
          const words=e.content.split(/\s+/).length;
          const readTime=Math.ceil(words/200);

          div.innerHTML=`
            <h3>${e.title}</h3>
            <div class="meta">Tags: ${(e.tags||[]).join(", ")} | ${words} words ~ ${readTime} min</div>
            <div class="content">${renderMarkdown(e.content).substring(0,200)}...</div>
            ${e.attachment ? `<div class="attachment">📎 <a href="${e.attachment.data}" download="${e.attachment.name}">${e.attachment.name}</a></div>`:""}
            <div class="actions">
              <button class="edit" onclick="editWiki(${e.id})">Edit</button>
              <button class="delete" onclick="deleteWiki(${e.id})">Delete</button>
              <button class="pin" onclick="togglePin(${e.id})">${e.pinned?"Unpin":"Pin"}</button>
              <button class="star" onclick="toggleStar(${e.id})">${e.starred?"Unstar":"Star"}</button>
              <button class="collapse" onclick="toggleCollapse(this)">Expand</button>
            </div>
            <div class="full hidden">${renderMarkdown(e.content)}</div>
          `;
          container.appendChild(div);
        });
      };
    }

    // 🔍 Search via Cross-link
    function searchLink(title){
      document.getElementById("search").value=title;
      displayWiki();
    }

    // ✏️ Edit
    function editWiki(id){
      const tx=db.transaction("wiki","readonly");
      const req=tx.objectStore("wiki").get(id);
      req.onsuccess=()=>{
        const e=req.result;
        document.getElementById("title").value=e.title;
        document.getElementById("content").value=e.content;
        document.getElementById("tags").value=(e.tags||[]).join(", ");
        const btn=document.getElementById("saveBtn");
        btn.textContent="Update Wiki";
        btn.setAttribute("data-edit",id);

        // Save to history
        const txh=db.transaction("wiki_history","readwrite");
        txh.objectStore("wiki_history").add({...e,timestamp:Date.now()});
      };
    }

    // ❌ Delete
    function deleteWiki(id){
      const tx=db.transaction("wiki","readwrite");
      tx.objectStore("wiki").delete(id);
      tx.oncomplete=displayWiki;
    }

    // 📌 Pin
    function togglePin(id){
      const tx=db.transaction("wiki","readwrite");
      const store=tx.objectStore("wiki");
      const req=store.get(id);
      req.onsuccess=()=>{const e=req.result; e.pinned=!e.pinned; store.put(e); tx.oncomplete=displayWiki;};
    }

    // ⭐ Star
    function toggleStar(id){
      const tx=db.transaction("wiki","readwrite");
      const store=tx.objectStore("wiki");
      const req=store.get(id);
      req.onsuccess=()=>{const e=req.result; e.starred=!e.starred; store.put(e); tx.oncomplete=displayWiki;};
    }

    // 🔽 Expand/Collapse
    function toggleCollapse(btn){
      const full=btn.parentElement.nextElementSibling;
      full.classList.toggle("hidden");
      btn.textContent=full.classList.contains("hidden")?"Expand":"Collapse";
    }

    // 🔎 Live Search + Sorting
    document.getElementById("search").addEventListener("input",displayWiki);
    document.getElementById("sort").addEventListener("change",displayWiki);
  </script>
</body>
</html>
