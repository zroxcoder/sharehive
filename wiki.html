<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShareHive - Wiki</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: 0.3s;
      font-size: 16px;
      overflow: hidden;
    }
    :root {
      --bg-color: #ffffff; --text-color: #222;
      --primary-color: #0077ff; --secondary-color: #00c896; --sidebar-bg: #f7f7f7; --card-bg: #ffffff;
      --border-color: #e0e0e0; --success-color: #28a745; --warning-color: #ffc107;
      --danger-color: #dc3545; --info-color: #17a2b8;
    }
    body.dark {
      --bg-color: #1e1e1e; --text-color: #f0f0f0; --sidebar-bg: #2c2c2c;
      --card-bg: #333333; --border-color: #444;
    }

    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color), #0056cc); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar h1 { font-size: 20px; }
    .toggle-btn { background: white; border: none; color: var(--primary-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .toggle-btn:hover { transform: scale(1.05); box-shadow: 0 3px 8px rgba(0,0,0,0.3); }

    .container { display: flex; height: calc(100vh - 50px); }
    
    .sidebar { width: 220px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); }
    .sidebar a { display: block; text-decoration: none; color: var(--text-color); padding: 8px 10px; border-radius: 5px; margin-bottom: 5px; transition: all 0.3s ease; }
    .sidebar a:hover { background: var(--primary-color); color: white; transform: translateX(5px); }
    .sidebar a[href="wiki.html"] { background: var(--primary-color); color:white; font-weight:bold; }

    .main { flex: 1; display: flex; overflow: hidden; padding:0; }

    .wiki-sidebar { width: 280px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); display:flex; flex-direction:column; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    
    .sidebar-header { margin-bottom: 20px; }
    .search-box { width: 100%; padding: 10px 15px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); font-size: 14px; margin-bottom:15px; }
    .add-page-btn { width: 100%; padding: 10px; border: none; background: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:10px; }
    .add-page-btn:hover { background: #0056cc; }

    .templates-btn { width: 100%; padding: 8px; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 8px; cursor: pointer; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:15px; }
    .templates-btn:hover { background: var(--bg-color); }

    .favorites-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .section-title { font-size: 12px; font-weight: bold; text-transform: uppercase; color: #888; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }

    .page-tree { list-style: none; padding-left: 0; }
    .page-tree-item { margin: 2px 0; position:relative; }
    .page-tree-item.nested { padding-left: 20px; }
    .expand-icon { cursor: pointer; padding: 2px 4px; user-select: none; display: inline-block; width: 20px; text-align: center; }
    .expand-icon.collapsed:before { content: '▶'; font-size: 10px; }
    .expand-icon.expanded:before { content: '▼'; font-size: 10px; }
    .children-pages { display: none; padding-left: 20px; }
    .children-pages.show { display: block; }
    
    .page-link { display: flex; align-items: center; gap: 8px; padding: 6px 8px; text-decoration: none; color: var(--text-color); border-radius: 5px; transition: background 0.2s; cursor: pointer; position: relative; }
    .page-link:hover { background: var(--bg-color); }
    .page-link.active { background: var(--primary-color); color: white; }
    .page-icon { font-size: 16px; flex-shrink: 0; }
    .page-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; min-width: 0; }
    .page-link-actions { display: none; align-items: center; gap: 4px; margin-left: auto; }
    .page-tree-item:hover .page-link-actions { display: flex; }
    .star-icon, .add-sub-icon, .delete-icon { cursor: pointer; font-size: 14px; padding: 2px 4px; opacity: 0.6; flex-shrink: 0; }
    .star-icon:hover, .add-sub-icon:hover, .delete-icon:hover { opacity: 1; }
    .star-icon.starred { opacity: 1; color: gold; }

    /* Editor Area */
    .editor-container { flex: 1; overflow-y: auto; padding: 0; }
    .editor-container.full-width .page-header,
    .editor-container.full-width .block-editor,
    .editor-container.full-width .page-actions-bar { max-width: 100% !important; }
    
    /* Page Header */
    .page-header { padding: 40px 96px 0 96px; max-width: 900px; margin: 0 auto; width: 100%; }
    .page-cover { height: 200px; width: 100%; background-size: cover; background-position: center; position: relative; margin-bottom: 20px; border-radius: 3px; cursor: pointer; }
    .page-cover:hover .cover-actions { opacity: 1; }
    .cover-actions { position: absolute; bottom: 10px; right: 10px; opacity: 0; transition: opacity 0.2s; display: flex; gap: 8px; }
    .cover-actions button { background: rgba(0,0,0,0.6); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .cover-actions button:hover { background: rgba(0,0,0,0.8); }

    .page-icon-picker { display: inline-block; font-size: 78px; cursor: pointer; margin-bottom: 10px; transition: transform 0.2s; }
    .page-icon-picker:hover { transform: scale(1.1); }

    .breadcrumbs { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; font-size: 14px; color: #888; flex-wrap: wrap; }
    .breadcrumbs a { color: #888; text-decoration: none; }
    .breadcrumbs a:hover { color: var(--primary-color); }

    .editor-title { width: 100%; font-size: 40px; font-weight: bold; border: none; background: transparent; color: var(--text-color); padding: 4px 0; margin-bottom: 10px; font-family: inherit; }
    .editor-title:focus { outline:none; }
    .editor-title::placeholder { color: #999; }

    /* Properties */
    .properties-section { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .property { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--sidebar-bg); border-radius: 5px; font-size: 14px; position: relative; }
    .property-label { font-weight: 600; color: #888; font-size: 12px; }
    .property-value { color: var(--text-color); }
    .property-input { border: none; background: transparent; color: var(--text-color); font-size: 14px; outline: none; min-width: 80px; }
    .property-remove { cursor: pointer; margin-left: 6px; opacity: 0.6; }
    .property-remove:hover { opacity: 1; color: var(--danger-color); }
    .add-property-btn { padding: 6px 12px; background: transparent; border: 1px dashed var(--border-color); border-radius: 5px; cursor: pointer; font-size: 13px; color: #888; }
    .add-property-btn:hover { background: var(--sidebar-bg); }

    /* Block Editor */
    .block-editor { padding: 0 96px 100px 96px; min-height: 500px; max-width: 900px; margin: 0 auto; width: 100%; }
    
    .block { position: relative; margin-bottom: 2px; padding: 3px 0; cursor: text; }
    .block:hover .block-controls { opacity: 1; }
    
    .block-controls { position: absolute; left: -40px; top: 3px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
    .block-handle { cursor: grab; font-size: 18px; color: #999; padding: 2px 4px; }
    .block-handle:active { cursor: grabbing; }
    .block-menu-btn { cursor: pointer; font-size: 16px; color: #999; padding: 2px 4px; background: none; border: none; }
    .block-menu-btn:hover { background: var(--sidebar-bg); border-radius: 3px; }

    .block.dragging { opacity: 0.5; }
    .block.drag-over { border-top: 2px solid var(--primary-color); }

    .block-content { min-height: 28px; padding: 3px 2px; outline: none; line-height: 1.6; }
    .block-content:focus { background: rgba(0, 119, 255, 0.05); }
    .block-content:empty:before { content: attr(data-placeholder); color: #999; }

    /* Block Types */
    .block[data-type="h1"] .block-content { font-size: 32px; font-weight: bold; margin-top: 20px; }
    .block[data-type="h2"] .block-content { font-size: 24px; font-weight: bold; margin-top: 16px; }
    .block[data-type="h3"] .block-content { font-size: 20px; font-weight: bold; margin-top: 12px; }
    .block[data-type="quote"] .block-content { border-left: 3px solid var(--primary-color); padding-left: 15px; font-style: italic; color: #666; }
    .block[data-type="code"] .block-content { font-family: 'Courier New', monospace; background: var(--sidebar-bg); padding: 12px; border-radius: 5px; white-space: pre; overflow-x: auto; }
    .block[data-type="divider"] { height: 1px; background: var(--border-color); margin: 20px 0; }
    
    /* To-do */
    .block[data-type="todo"] .block-content { display: flex; align-items: flex-start; gap: 8px; }
    .todo-checkbox { margin-top: 3px; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0; }
    .todo-text { flex: 1; min-width: 0; }
    .block[data-type="todo"].checked .todo-text { text-decoration: line-through; opacity: 0.6; }

    /* Bulleted/Numbered Lists */
    .block[data-type="bullet"] .block-content { display: flex; gap: 8px; padding-left: 24px; }
    .block[data-type="bullet"] .block-content:before { content: '•'; position: absolute; left: 98px; font-size: 20px; }
    .block[data-type="numbered"] .block-content { display: flex; gap: 8px; padding-left: 24px; }

    /* Toggle Block */
    .block[data-type="toggle"] .block-content { display: flex; gap: 8px; }
    .toggle-arrow { cursor: pointer; user-select: none; transition: transform 0.2s; }
    .toggle-arrow.open { transform: rotate(90deg); }
    .toggle-children { margin-left: 24px; display: none; }
    .toggle-children.open { display: block; }

    /* Callout */
    .block[data-type="callout"] .block-content { display: flex; gap: 12px; padding: 12px; background: var(--sidebar-bg); border-radius: 5px; border-left: 3px solid var(--primary-color); }
    .callout-icon { font-size: 24px; flex-shrink: 0; cursor: pointer; }
    .callout-text { flex: 1; }

    /* Table */
    .block[data-type="table"] .block-content { padding: 0; overflow-x: auto; }
    .notion-table { width: 100%; border-collapse: collapse; min-width: 400px; }
    .notion-table td { border: 1px solid var(--border-color); padding: 8px; min-width: 100px; outline: none; }
    .notion-table tr:first-child td { background: var(--sidebar-bg); font-weight: bold; }
    .table-controls { margin-top: 8px; display: flex; gap: 8px; }
    .table-controls button { padding: 4px 8px; font-size: 12px; background: var(--sidebar-bg); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }

    /* Image */
    .block[data-type="image"] .block-content { padding: 0; }
    .block-image { max-width: 100%; border-radius: 5px; cursor: pointer; }
    .image-placeholder { padding: 40px; text-align: center; border: 2px dashed var(--border-color); border-radius: 5px; cursor: pointer; color: #999; }
    .image-caption { margin-top: 8px; font-size: 14px; color: #888; text-align: center; outline: none; }

    /* Columns */
    .block[data-type="columns"] .block-content { display: flex; gap: 12px; }
    .column { flex: 1; padding: 8px; border: 1px dashed transparent; border-radius: 4px; min-height: 50px; }
    .column:hover { border-color: var(--border-color); }

    /* Embed */
    .block[data-type="embed"] .block-content { padding: 0; }
    .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
    .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* Page Link */
    .block[data-type="link"] .block-content { padding: 12px; background: var(--sidebar-bg); border-radius: 5px; border: 1px solid var(--border-color); cursor: pointer; }
    .block[data-type="link"] .block-content:hover { background: var(--bg-color); }
    .page-link-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }

    /* Comments */
    .comments-toggle { position: fixed; right: 20px; top: 80px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100; }
    .comments-toggle:hover { background: var(--primary-color); color: white; }
    .comments-panel { position: fixed; right: -350px; top: 50px; width: 350px; height: calc(100vh - 50px); background: var(--card-bg); border-left: 1px solid var(--border-color); transition: right 0.3s; overflow-y: auto; z-index: 99; padding: 20px; }
    .comments-panel.show { right: 0; }
    .comment { padding: 12px; background: var(--sidebar-bg); border-radius: 8px; margin-bottom: 12px; }
    .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #888; }
    .comment-text { font-size: 14px; }
    .comment-input { width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); resize: vertical; min-height: 80px; font-family: inherit; }
    .add-comment-btn { margin-top: 10px; width: 100%; padding: 8px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; }

    /* Formatting Toolbar */
    .formatting-toolbar { position: fixed; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 6px; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .formatting-toolbar.show { display: flex; gap: 4px; }
    .formatting-toolbar button { background: transparent; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; color: var(--text-color); }
    .formatting-toolbar button:hover { background: var(--sidebar-bg); }
    .formatting-toolbar .separator { width: 1px; background: var(--border-color); margin: 0 4px; }

    /* Slash Command Menu */
    .slash-menu { position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; max-height: 400px; overflow-y: auto; z-index: 100; display: none; min-width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .slash-menu.show { display: block; }
    .slash-menu-section { margin-bottom: 12px; }
    .slash-menu-section:last-child { margin-bottom: 0; }
    .slash-menu-title { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #888; padding: 4px 8px; margin-bottom: 4px; }
    .slash-menu-item { padding: 8px 12px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
    .slash-menu-item:hover, .slash-menu-item.selected { background: var(--primary-color); color: white; }
    .slash-menu-item.selected .slash-menu-item-desc { color: #e0e0e0; }
    .slash-menu-item-icon { font-size: 20px; width: 24px; text-align: center; }
    .slash-menu-item-content { flex: 1; }
    .slash-menu-item-title { font-weight: 600; font-size: 14px; }
    .slash-menu-item-desc { font-size: 12px; color: #888; }

    /* Block Context Menu */
    .block-context-menu { position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; }
    .block-context-menu.show { display: block; }
    .context-menu-item { padding: 8px 12px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .context-menu-item:hover { background: var(--sidebar-bg); }
    .context-menu-separator { height: 1px; background: var(--border-color); margin: 4px 0; }
    .context-menu-section { padding: 4px 0; }
    .context-menu-section-title { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #888; padding: 4px 12px; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { font-size: 20px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); }
    .modal-body { margin-bottom: 20px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

    /* Templates Grid */
    .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .template-card { padding: 20px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .template-card:hover { border-color: var(--primary-color); transform: translateY(-2px); }
    .template-icon { font-size: 32px; margin-bottom: 8px; }
    .template-name { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
    .template-desc { font-size: 12px; color: #888; }

    /* Icon Picker */
    .icon-picker-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; }
    .icon-option { font-size: 32px; padding: 8px; cursor: pointer; border-radius: 5px; text-align: center; }
    .icon-option:hover { background: var(--sidebar-bg); }

    /* Export Menu */
    .export-options { display: flex; flex-direction: column; gap: 10px; }
    .export-option { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
    .export-option:hover { background: var(--sidebar-bg); }

    /* Property Modal */
    .property-type-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .property-type-option { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; }
    .property-type-option:hover { background: var(--sidebar-bg); }

    /* Buttons */
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #0056cc; }
    .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
    .btn-secondary:hover { background: var(--sidebar-bg); }
    
    /* Page Actions Bar */
    .page-actions-bar { display: flex; gap: 10px; padding: 10px 96px; border-bottom: 1px solid var(--border-color); max-width: 900px; margin: 0 auto; width: 100%; flex-wrap: wrap; }
    .action-btn { background: transparent; border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text-color); display: flex; align-items: center; gap: 6px; }
    .action-btn:hover { background: var(--sidebar-bg); }
    .action-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

    /* TOC Panel */
    .toc-panel { position: fixed; right: 20px; top: 140px; width: 200px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; display: none; }
    .toc-panel.show { display: block; }
    .toc-title { font-weight: bold; margin-bottom: 10px; font-size: 14px; }
    .toc-list { list-style: none; }
    .toc-list li { margin-bottom: 6px; }
    .toc-list a { color: var(--text-color); text-decoration: none; font-size: 13px; opacity: 0.7; }
    .toc-list a:hover { opacity: 1; color: var(--primary-color); }
    .toc-list .toc-h2 { padding-left: 0; }
    .toc-list .toc-h3 { padding-left: 15px; }

    @media (max-width: 1200px) {
      .page-header, .block-editor, .page-actions-bar { padding-left: 40px; padding-right: 40px; }
      .block-controls { left: -30px; }
      .toc-panel { display: none !important; }
      .comments-toggle { display: none; }
    }
    
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar { display:none; }
      .wiki-sidebar { width: 100%; height:auto; max-height: 200px; border-right:none; border-bottom:1px solid var(--border-color); }
      .page-header, .block-editor, .page-actions-bar { padding-left: 20px; padding-right: 20px; }
      .block-controls { position: static; opacity: 1; margin-bottom: 5px; }
      .block[data-type="bullet"] .block-content:before { left: 20px; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>🐝 ShareHive - Wiki</h1>
    <button class="toggle-btn" onclick="toggleTheme()">🌙</button>
  </div>

  <div class="container">
    <div class="sidebar">
      <a href="index.html">🏠 Dashboard</a>
      <a href="notes.html">📝 Notes</a>
      <a href="bookmarks.html">🔖 Bookmarks</a>
      <a href="videos.html">🎬 Videos</a>
      <a href="todo.html">✅ To-Do</a>
      <a href="expense.html">💰 Expenses</a>
      <a href="planner.html">📅 Planner</a>
      <a href="wiki.html">📖 Wiki</a>
      <a href="uploads.html">📂 Uploads</a>
      <a href="projects.html">📌 Projects</a>
      <a href="watchlist.html">🎥 Watchlist</a>
      <a href="courses.html">📚 Courses</a>
      <a href="profile.html">👤 Profile</a>
      <a href="settings.html">⚙️ Settings</a>
      <hr>
      <a href="about.html">ℹ️ About</a>
      <a href="help.html">❓ Help</a>
      <a href="faq.html">❔ FAQ</a>
      <a href="blog.html">📰 Blog</a>
      <a href="contact.html">✉️ Contact</a>
      <a href="join.html">🤝 Join</a>
      <a href="report.html">🐞 Report</a>
      <a href="privacy.html">📜 Privacy</a>
      <a href="community.html">🌍 Community</a>
    </div>

    <div class="main">
      <aside class="wiki-sidebar">
        <div class="sidebar-header">
          <input type="text" id="search" class="search-box" placeholder="🔍 Search pages...">
          <button class="add-page-btn" onclick="createNewPage()"><span>➕</span> New Page</button>
          <button class="templates-btn" onclick="showTemplates()"><span>📋</span> Templates</button>
        </div>
        
        <div class="favorites-section" id="favoritesSection">
          <div class="section-title">
            <span>⭐ Favorites</span>
          </div>
          <ul class="page-tree" id="favoritesTree"></ul>
        </div>

        <div class="section-title">
          <span>📄 All Pages</span>
        </div>
        <ul class="page-tree" id="pageTree"></ul>
      </aside>

      <main class="main-content">
        <div class="page-actions-bar">
          <button class="action-btn" onclick="toggleComments()">
            <span>💬</span> Comments
          </button>
          <button class="action-btn" id="fullWidthToggle" onclick="toggleFullWidth()">
            <span>↔️</span> Full Width
          </button>
          <button class="action-btn" onclick="toggleTOC()">
            <span>📑</span> TOC
          </button>
          <button class="action-btn" onclick="showExportMenu()">
            <span>📤</span> Export
          </button>
          <button class="action-btn" onclick="duplicatePage()">
            <span>📑</span> Duplicate
          </button>
          <button class="action-btn" onclick="confirmDeletePage()">
            <span>🗑️</span> Delete
          </button>
        </div>

        <div class="editor-container" id="editorContainer">
          <div class="page-header">
            <div class="breadcrumbs" id="breadcrumbs"></div>
            
            <div class="page-cover" id="pageCover" style="display:none;">
              <div class="cover-actions">
                <button onclick="changeCover()">Change</button>
                <button onclick="removeCover()">Remove</button>
              </div>
            </div>

            <div class="page-icon-picker" id="pageIconPicker" onclick="showIconPicker()">📄</div>
            
            <input type="text" id="titleEditor" class="editor-title" placeholder="Untitled">

            <div class="properties-section" id="propertiesSection">
              <button class="add-property-btn" onclick="showAddProperty()">+ Add Property</button>
            </div>
          </div>

          <div class="block-editor" id="blockEditor"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Comments Panel -->
  <div class="comments-toggle" onclick="toggleComments()" title="Comments">💬</div>
  <div class="comments-panel" id="commentsPanel">
    <h3 style="margin-bottom:20px;">💬 Comments</h3>
    <div id="commentsList"></div>
    <textarea class="comment-input" id="commentInput" placeholder="Add a comment..."></textarea>
    <button class="add-comment-btn" onclick="addComment()">Add Comment</button>
  </div>

  <!-- TOC Panel -->
  <div class="toc-panel" id="tocPanel">
    <div class="toc-title">📑 Table of Contents</div>
    <ul class="toc-list" id="tocList"></ul>
  </div>

  <!-- Formatting Toolbar -->
  <div class="formatting-toolbar" id="formattingToolbar">
    <button onclick="formatText('bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
    <button onclick="formatText('italic')" title="Italic (Ctrl+I)"><em>I</em></button>
    <button onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
    <button onclick="formatText('strikethrough')" title="Strikethrough"><s>S</s></button>
    <div class="separator"></div>
    <button onclick="formatText('insertUnorderedList')" title="Bullet List">• List</button>
    <button onclick="createLink()" title="Link">🔗</button>
  </div>

  <!-- Slash Command Menu -->
  <div class="slash-menu" id="slashMenu"></div>

  <!-- Block Context Menu -->
  <div class="block-context-menu" id="blockContextMenu"></div>

  <!-- Modals -->
  <div class="modal" id="templatesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📋 Page Templates</h3>
        <button class="modal-close" onclick="closeModal('templatesModal')">×</button>
      </div>
      <div class="modal-body">
        <div class="templates-grid">
          <div class="template-card" onclick="applyTemplate('meeting')">
            <div class="template-icon">📅</div>
            <div class="template-name">Meeting Notes</div>
            <div class="template-desc">Track meeting details</div>
          </div>
          <div class="template-card" onclick="applyTemplate('project')">
            <div class="template-icon">📌</div>
            <div class="template-name">Project Plan</div>
            <div class="template-desc">Organize project tasks</div>
          </div>
          <div class="template-card" onclick="applyTemplate('doc')">
            <div class="template-icon">📄</div>
            <div class="template-name">Document</div>
            <div class="template-desc">Standard document</div>
          </div>
          <div class="template-card" onclick="applyTemplate('wiki')">
            <div class="template-icon">📖</div>
            <div class="template-name">Wiki Page</div>
            <div class="template-desc">Knowledge base entry</div>
          </div>
          <div class="template-card" onclick="applyTemplate('roadmap')">
            <div class="template-icon">🗺️</div>
            <div class="template-name">Roadmap</div>
            <div class="template-desc">Timeline planning</div>
          </div>
          <div class="template-card" onclick="applyTemplate('blank')">
            <div class="template-icon">📝</div>
            <div class="template-name">Blank Page</div>
            <div class="template-desc">Start from scratch</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="iconPickerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Choose Icon</h3>
        <button class="modal-close" onclick="closeModal('iconPickerModal')">×</button>
      </div>
      <div class="modal-body">
        <div class="icon-picker-grid" id="iconPickerGrid"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📤 Export Page</h3>
        <button class="modal-close" onclick="closeModal('exportModal')">×</button>
      </div>
      <div class="modal-body">
        <div class="export-options">
          <div class="export-option" onclick="exportPage('markdown')">
            <span style="font-size:24px;">📝</span>
            <div>
              <div style="font-weight:600;">Markdown</div>
              <div style="font-size:12px;color:#888;">Plain text format</div>
            </div>
          </div>
          <div class="export-option" onclick="exportPage('html')">
            <span style="font-size:24px;">🌐</span>
            <div>
              <div style="font-weight:600;">HTML</div>
              <div style="font-size:12px;color:#888;">Web page format</div>
            </div>
          </div>
          <div class="export-option" onclick="exportPage('json')">
            <span style="font-size:24px;">📋</span>
            <div>
              <div style="font-weight:600;">JSON</div>
              <div style="font-size:12px;color:#888;">Data format</div>
            </div>
          </div>
          <div class="export-option" onclick="exportPage('pdf')">
            <span style="font-size:24px;">📄</span>
            <div>
              <div style="font-weight:600;">PDF</div>
              <div style="font-size:12px;color:#888;">Print ready format</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="propertyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Property</h3>
        <button class="modal-close" onclick="closeModal('propertyModal')">×</button>
      </div>
      <div class="modal-body">
        <input type="text" id="propertyName" placeholder="Property name" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:8px;margin-bottom:15px;">
        <div class="property-type-grid">
          <div class="property-type-option" onclick="addProperty('text')">
            <div style="font-size:24px;">📝</div>
            <div>Text</div>
          </div>
          <div class="property-type-option" onclick="addProperty('select')">
            <div style="font-size:24px;">🏷️</div>
            <div>Select</div>
          </div>
          <div class="property-type-option" onclick="addProperty('date')">
            <div style="font-size:24px;">📅</div>
            <div>Date</div>
          </div>
          <div class="property-type-option" onclick="addProperty('checkbox')">
            <div style="font-size:24px;">☑️</div>
            <div>Checkbox</div>
          </div>
          <div class="property-type-option" onclick="addProperty('url')">
            <div style="font-size:24px;">🔗</div>
            <div>URL</div>
          </div>
          <div class="property-type-option" onclick="addProperty('email')">
            <div style="font-size:24px;">📧</div>
            <div>Email</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="pageLinkModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Link to Page</h3>
        <button class="modal-close" onclick="closeModal('pageLinkModal')">×</button>
      </div>
      <div class="modal-body">
        <input type="text" id="pageLinkSearch" placeholder="Search pages..." style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:8px;margin-bottom:15px;" oninput="searchPagesForLink(this.value)">
        <div id="pageLinkResults" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <script>
    // Theme Toggle
    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }
    if(localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

     // 📦 IndexedDB (v21 unified)
    let db;
    const stores = ["notes","bookmarks","videos","todos","expenses","planner","wiki","uploads","projects","watchlist","courses","profile","community"];
    const request = indexedDB.open("ShareHiveDB", 22);



    request.onupgradeneeded = function(e) {
      db = e.target.result;
      
      if (!db.objectStoreNames.contains("wiki")) {
        const store = db.createObjectStore("wiki", { keyPath: "id", autoIncrement: true });
        store.createIndex("title", "title", { unique: false });
        store.createIndex("parentId", "parentId", { unique: false });
      }
      
      if (!db.objectStoreNames.contains("wikiComments")) {
        const commentsStore = db.createObjectStore("wikiComments", { keyPath: "id", autoIncrement: true });
        commentsStore.createIndex("pageId", "pageId", { unique: false });
      }
    };

    request.onsuccess = function(e) { 
      db = e.target.result; 
      displayPageTree();
      loadInitialPage();
    };

    request.onerror = function(e) { 
      console.error("DB error:", e.target.error);
      // If DB fails, still create the welcome page in memory
      createWelcomePage();
    };

    // Global State
    let currentPageId = null;
    let currentBlock = null;
    let draggedBlock = null;
    let autoSaveTimer = null;
    let currentPageData = {};
    let slashMenuSelectedIndex = 0;
    let slashMenuItems = [];

    // Icons for icon picker
    const icons = ['📄', '📝', '📖', '📚', '📌', '📋', '📊', '📈', '📉', '🗂️', '📁', '📂', '🗃️', '🗄️', '📦', '🎯', '🎨', '🎭', '🎪', '🎬', '🎮', '🎲', '🧩', '🧠', '💡', '🔔', '🔍', '🔎', '🔬', '🔭', '⚗️', '⚙️', '🔧', '🔨', '⚡', '🔥', '💧', '🌊', '🌍', '🌎', '🌏', '🌐', '🗺️', '🧭', '⛰️', '🏔️', '🌋', '🗻', '🏕️', '🏖️', '🏜️', '🏝️', '🏞️', '🏟️', '🏛️', '🏗️', '🏘️', '🏚️', '🏠', '🏡', '🏢', '🏣', '🏤', '🏥', '🏦', '🏨', '🏩', '🏪', '🏫', '🏬', '🏭', '🏯', '🏰', '💒', '🗼', '🗽', '⛪', '🕌', '🛕', '🕍', '⛩️', '🕋', '⭐', '✨', '🎉', '🎊', '🎈', '🎁', '🏆', '🥇', '🥈', '🥉', '⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏉'];

    // Block Types Configuration
    const blockTypes = [
      { id: 'text', icon: '📝', title: 'Text', desc: 'Plain text paragraph', section: 'Basic Blocks' },
      { id: 'h1', icon: 'H1', title: 'Heading 1', desc: 'Large section heading', section: 'Basic Blocks' },
      { id: 'h2', icon: 'H2', title: 'Heading 2', desc: 'Medium section heading', section: 'Basic Blocks' },
      { id: 'h3', icon: 'H3', title: 'Heading 3', desc: 'Small section heading', section: 'Basic Blocks' },
      { id: 'todo', icon: '☑️', title: 'To-do', desc: 'Track tasks with checkbox', section: 'Basic Blocks' },
      { id: 'bullet', icon: '•', title: 'Bulleted List', desc: 'Simple bullet list', section: 'Basic Blocks' },
      { id: 'numbered', icon: '1.', title: 'Numbered List', desc: 'Ordered list', section: 'Basic Blocks' },
      { id: 'toggle', icon: '▶️', title: 'Toggle', desc: 'Collapsible content', section: 'Basic Blocks' },
      { id: 'quote', icon: '❝', title: 'Quote', desc: 'Capture a quote', section: 'Advanced' },
      { id: 'callout', icon: '💡', title: 'Callout', desc: 'Highlighted box', section: 'Advanced' },
      { id: 'code', icon: '💻', title: 'Code', desc: 'Code block', section: 'Advanced' },
      { id: 'divider', icon: '―', title: 'Divider', desc: 'Visual separator', section: 'Advanced' },
      { id: 'image', icon: '🖼️', title: 'Image', desc: 'Upload or embed', section: 'Media' },
      { id: 'embed', icon: '🎬', title: 'Embed', desc: 'Embed YouTube, etc.', section: 'Media' },
      { id: 'table', icon: '📊', title: 'Table', desc: 'Simple table', section: 'Media' },
      { id: 'columns', icon: '⚏', title: 'Columns', desc: 'Multi-column layout', section: 'Media' },
      { id: 'link', icon: '🔗', title: 'Page Link', desc: 'Link to another page', section: 'Links' }
    ];

    // Page Templates
    const templates = {
      meeting: {
        title: "Meeting Notes",
        icon: "📅",
        properties: [
          { name: "Date", type: "date", value: new Date().toISOString().split('T')[0] },
          { name: "Status", type: "select", value: "Scheduled" }
        ],
        blocks: [
          { type: 'h2', content: '👥 Attendees' },
          { type: 'bullet', content: 'Person 1' },
          { type: 'bullet', content: 'Person 2' },
          { type: 'h2', content: '📋 Agenda' },
          { type: 'todo', content: 'Topic 1', data: { checked: false } },
          { type: 'todo', content: 'Topic 2', data: { checked: false } },
          { type: 'h2', content: '📝 Notes' },
          { type: 'text', content: '' },
          { type: 'h2', content: '✅ Action Items' },
          { type: 'todo', content: 'Task 1', data: { checked: false } }
        ]
      },
      project: {
        title: "Project Plan",
        icon: "📌",
        properties: [
          { name: "Status", type: "select", value: "Planning" },
          { name: "Due Date", type: "date", value: "" }
        ],
        blocks: [
          { type: 'h2', content: '🎯 Overview' },
          { type: 'text', content: 'Project description goes here...' },
          { type: 'h2', content: '🎯 Goals' },
          { type: 'bullet', content: 'Goal 1' },
          { type: 'bullet', content: 'Goal 2' },
          { type: 'h2', content: '📅 Timeline' },
          { type: 'text', content: '' },
          { type: 'h2', content: '✅ Tasks' },
          { type: 'todo', content: 'Task 1', data: { checked: false } },
          { type: 'todo', content: 'Task 2', data: { checked: false } }
        ]
      },
      doc: {
        title: "New Document",
        icon: "📄",
        properties: [],
        blocks: [
          { type: 'text', content: 'Start writing here...' }
        ]
      },
      wiki: {
        title: "Wiki Entry",
        icon: "📖",
        properties: [
          { name: "Type", type: "select", value: "Article" }
        ],
        blocks: [
          { type: 'callout', content: 'Summary or key takeaway', data: { icon: '💡' } },
          { type: 'h2', content: 'Overview' },
          { type: 'text', content: 'Main content...' },
          { type: 'h2', content: 'Details' },
          { type: 'text', content: 'Detailed information...' },
          { type: 'h2', content: 'Related' },
          { type: 'bullet', content: 'Related topic 1' }
        ]
      },
      roadmap: {
        title: "Roadmap",
        icon: "🗺️",
        properties: [
          { name: "Year", type: "text", value: "2024" }
        ],
        blocks: [
          { type: 'h2', content: '📅 Q1 2024' },
          { type: 'todo', content: 'Milestone 1', data: { checked: false } },
          { type: 'h2', content: '📅 Q2 2024' },
          { type: 'todo', content: 'Milestone 2', data: { checked: false } }
        ]
      },
      blank: {
        title: "Untitled",
        icon: "📄",
        properties: [],
        blocks: [
          { type: 'text', content: '' }
        ]
      }
    };

    // Block Management
    function createBlock(type, content, data) {
      type = type || 'text';
      content = content || '';
      data = data || {};
      
      const block = document.createElement('div');
      block.className = 'block';
      block.setAttribute('data-type', type);
      block.setAttribute('data-id', Date.now() + Math.random());
      block.draggable = true;

      const controls = document.createElement('div');
      controls.className = 'block-controls';
      controls.innerHTML = `
        <span class="block-handle">⋮⋮</span>
        <button class="block-menu-btn" onclick="showBlockContextMenu(event, this)">⋯</button>
      `;
      block.appendChild(controls);

      const blockContent = document.createElement('div');
      blockContent.className = 'block-content';
      blockContent.contentEditable = true;

      // Different block types
      switch(type) {
        case 'text':
          blockContent.setAttribute('data-placeholder', 'Type \'/\' for commands');
          blockContent.innerHTML = content;
          break;
        case 'h1':
        case 'h2':
        case 'h3':
          blockContent.setAttribute('data-placeholder', 'Heading');
          blockContent.innerHTML = content;
          break;
        case 'todo':
          blockContent.contentEditable = false;
          blockContent.innerHTML = `
            <input type="checkbox" class="todo-checkbox" ${data.checked ? 'checked' : ''} onchange="toggleTodo(this)">
            <div class="todo-text" contenteditable="true">${content}</div>
          `;
          if(data.checked) block.classList.add('checked');
          break;
        case 'bullet':
        case 'numbered':
          blockContent.setAttribute('data-placeholder', 'List item');
          blockContent.innerHTML = content;
          break;
        case 'quote':
          blockContent.setAttribute('data-placeholder', 'Empty quote');
          blockContent.innerHTML = content;
          break;
        case 'code':
          blockContent.setAttribute('data-placeholder', '// code');
          blockContent.innerHTML = content;
          break;
        case 'callout':
          blockContent.contentEditable = false;
          blockContent.innerHTML = `
            <div class="callout-icon" onclick="changeCalloutIcon(this)">${data.icon || '💡'}</div>
            <div class="callout-text" contenteditable="true">${content}</div>
          `;
          break;
        case 'toggle':
          blockContent.contentEditable = false;
          blockContent.innerHTML = `
            <span class="toggle-arrow" onclick="toggleContent(this)">▶</span>
            <div class="toggle-text" contenteditable="true">${content}</div>
          `;
          const toggleChildren = document.createElement('div');
          toggleChildren.className = 'toggle-children';
          block.appendChild(toggleChildren);
          break;
        case 'divider':
          blockContent.contentEditable = false;
          break;
        case 'table':
          blockContent.contentEditable = false;
          blockContent.innerHTML = `
            <table class="notion-table">
              <tr><td contenteditable="true">Header 1</td><td contenteditable="true">Header 2</td><td contenteditable="true">Header 3</td></tr>
              <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
              <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
            </table>
            <div class="table-controls">
              <button onclick="addTableRow(this)">+ Row</button>
              <button onclick="addTableColumn(this)">+ Column</button>
            </div>
          `;
          break;
        case 'columns':
          blockContent.contentEditable = false;
          blockContent.innerHTML = `
            <div class="column" contenteditable="true">Column 1</div>
            <div class="column" contenteditable="true">Column 2</div>
          `;
          break;
        case 'image':
          blockContent.contentEditable = false;
          if(data.src) {
            blockContent.innerHTML = `
              <img src="${data.src}" class="block-image" alt="" onclick="viewImage(this.src)">
              <div class="image-caption" contenteditable="true" data-placeholder="Add a caption...">${data.caption || ''}</div>
            `;
          } else {
            blockContent.innerHTML = `<div class="image-placeholder" onclick="uploadImage(this)">Click to upload image or paste URL</div>`;
          }
          break;
        case 'embed':
          blockContent.contentEditable = false;
          if(data.url) {
            const embedUrl = getEmbedUrl(data.url);
            blockContent.innerHTML = `
              <div class="embed-container">
                <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
              </div>
            `;
          } else {
            blockContent.innerHTML = `<div class="image-placeholder" onclick="addEmbed(this)">Click to add embed (YouTube, etc.)</div>`;
          }
          break;
        case 'link':
          blockContent.contentEditable = false;
          if(data.pageId) {
            blockContent.innerHTML = `<div class="page-link-title" onclick="openPage(${data.pageId})">${data.icon || '📄'} ${data.title || 'Untitled'}</div>`;
          } else {
            blockContent.innerHTML = `<div class="image-placeholder" onclick="selectPageLink(this)">Click to select a page to link</div>`;
          }
          break;
      }

      block.appendChild(blockContent);

      // Event Listeners
      block.addEventListener('dragstart', handleDragStart);
      block.addEventListener('dragend', handleDragEnd);
      block.addEventListener('dragover', handleDragOver);
      block.addEventListener('drop', handleDrop);

      blockContent.addEventListener('input', function(e) {
        handleSlashCommand(e);
        scheduleAutoSave();
      });

      blockContent.addEventListener('keydown', handleBlockKeydown);
      blockContent.addEventListener('mouseup', handleTextSelection);
      blockContent.addEventListener('focus', function() {
        currentBlock = block;
      });

      // Paste handler for images
      if(type === 'image') {
        blockContent.addEventListener('paste', function(e) {
          const text = e.clipboardData.getData('text');
          if(text && (text.startsWith('http://') || text.startsWith('https://'))) {
            e.preventDefault();
            const img = document.createElement('img');
            img.src = text;
            img.className = 'block-image';
            img.onclick = function() { viewImage(text); };
            blockContent.innerHTML = '';
            blockContent.appendChild(img);
            const caption = document.createElement('div');
            caption.className = 'image-caption';
            caption.contentEditable = true;
            caption.setAttribute('data-placeholder', 'Add a caption...');
            blockContent.appendChild(caption);
            scheduleAutoSave();
          }
        });
      }

      return block;
    }

    function insertBlock(type, afterBlock) {
      const block = createBlock(type);
      const editor = document.getElementById('blockEditor');
      
      if(afterBlock) {
        afterBlock.after(block);
      } else if(currentBlock) {
        currentBlock.after(block);
      } else {
        editor.appendChild(block);
      }

      const contentEl = block.querySelector('[contenteditable="true"]');
      if(contentEl) {
        contentEl.focus();
      }

      hideSlashMenu();
      scheduleAutoSave();
      return block;
    }

    function deleteBlock(block) {
      if(!block) return;
      const prev = block.previousElementSibling;
      const next = block.nextElementSibling;
      block.remove();
      
      if(prev && prev.classList.contains('block')) {
        const contentEl = prev.querySelector('[contenteditable="true"]');
        if(contentEl) contentEl.focus();
      } else if(next && next.classList.contains('block')) {
        const contentEl = next.querySelector('[contenteditable="true"]');
        if(contentEl) contentEl.focus();
      }
      
      scheduleAutoSave();
    }

    function duplicateBlock(block) {
      if(!block) return;
      const type = block.getAttribute('data-type');
      const contentEl = block.querySelector('.block-content');
      let content = '';
      let data = {};
      
      if(type === 'todo') {
        const checkbox = block.querySelector('.todo-checkbox');
        const text = block.querySelector('.todo-text');
        content = text ? text.innerHTML : '';
        data.checked = checkbox ? checkbox.checked : false;
      } else if(type === 'callout') {
        const iconEl = block.querySelector('.callout-icon');
        const textEl = block.querySelector('.callout-text');
        data.icon = iconEl ? iconEl.textContent : '💡';
        content = textEl ? textEl.innerHTML : '';
      } else {
        content = contentEl ? contentEl.innerHTML : '';
      }
      
      const newBlock = createBlock(type, content, data);
      block.after(newBlock);
      scheduleAutoSave();
    }

    function convertBlockType(block, newType) {
      if(!block) return;
      
      const contentEl = block.querySelector('.block-content');
      const currentContent = contentEl ? contentEl.textContent : '';
      
      const newBlock = createBlock(newType, currentContent);
      block.replaceWith(newBlock);
      
      const newContentEl = newBlock.querySelector('[contenteditable="true"]');
      if(newContentEl) {
        newContentEl.focus();
      }
      
      scheduleAutoSave();
    }

    function toggleTodo(checkbox) {
      const block = checkbox.closest('.block');
      if(checkbox.checked) {
        block.classList.add('checked');
      } else {
        block.classList.remove('checked');
      }
      scheduleAutoSave();
    }

    function toggleContent(arrow) {
      arrow.classList.toggle('open');
      const block = arrow.closest('.block');
      const children = block.querySelector('.toggle-children');
      if(children) {
        children.classList.toggle('open');
      }
    }

    function changeCalloutIcon(iconEl) {
      const newIcon = prompt('Enter emoji icon:', iconEl.textContent);
      if(newIcon) {
        iconEl.textContent = newIcon;
        scheduleAutoSave();
      }
    }

    function addTableRow(btn) {
      const table = btn.closest('.block-content').querySelector('table');
      const colCount = table.rows[0].cells.length;
      const newRow = table.insertRow();
      for(let i = 0; i < colCount; i++) {
        const cell = newRow.insertCell();
        cell.contentEditable = true;
      }
      scheduleAutoSave();
    }

    function addTableColumn(btn) {
      const table = btn.closest('.block-content').querySelector('table');
      for(let i = 0; i < table.rows.length; i++) {
        const cell = table.rows[i].insertCell();
        cell.contentEditable = true;
        if(i === 0) {
          cell.textContent = 'Header ' + (table.rows[0].cells.length);
        }
      }
      scheduleAutoSave();
    }

    function viewImage(src) {
      window.open(src, '_blank');
    }

    function getEmbedUrl(url) {
      if(url.includes('youtube.com/watch')) {
        const videoId = url.split('v=')[1]?.split('&')[0];
        return `https://www.youtube.com/embed/${videoId}`;
      } else if(url.includes('youtu.be/')) {
        const videoId = url.split('youtu.be/')[1]?.split('?')[0];
        return `https://www.youtube.com/embed/${videoId}`;
      }
      return url;
    }

    function addEmbed(placeholder) {
      const url = prompt('Enter embed URL (YouTube, etc.):');
      if(url) {
        const embedUrl = getEmbedUrl(url);
        placeholder.outerHTML = `
          <div class="embed-container">
            <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
          </div>
        `;
        scheduleAutoSave();
      }
    }

    function selectPageLink(placeholder) {
      document.getElementById('pageLinkModal').classList.add('show');
      searchPagesForLink('');
      window.currentLinkPlaceholder = placeholder;
    }

    function searchPagesForLink(query) {
      const tx = db.transaction("wiki", "readonly");
      const store = tx.objectStore("wiki");
      const getAllReq = store.getAll();
      
      getAllReq.onsuccess = function(e) {
        const pages = e.target.result || [];
        const results = document.getElementById('pageLinkResults');
        results.innerHTML = '';
        
        const filtered = pages.filter(function(p) {
          return (p.title || '').toLowerCase().includes(query.toLowerCase());
        });
        
        filtered.forEach(function(page) {
          const item = document.createElement('div');
          item.style.cssText = 'padding:10px;cursor:pointer;border-radius:5px;margin-bottom:5px;';
          item.innerHTML = `${page.icon || '📄'} ${page.title || 'Untitled'}`;
          item.onmouseover = function() { item.style.background = 'var(--sidebar-bg)'; };
          item.onmouseout = function() { item.style.background = 'transparent'; };
          item.onclick = function() {
            if(window.currentLinkPlaceholder) {
              window.currentLinkPlaceholder.outerHTML = `<div class="page-link-title" onclick="openPage(${page.id})">${page.icon || '📄'} ${page.title || 'Untitled'}</div>`;
              scheduleAutoSave();
            }
            closeModal('pageLinkModal');
          };
          results.appendChild(item);
        });
      };
    }

    // Drag and Drop
    function handleDragStart(e) {
      draggedBlock = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.block').forEach(function(b) {
        b.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const afterElement = getDragAfterElement(document.getElementById('blockEditor'), e.clientY);
      document.querySelectorAll('.block').forEach(function(b) {
        b.classList.remove('drag-over');
      });
      
      if(afterElement == null) {
        this.classList.add('drag-over');
      } else {
        afterElement.classList.add('drag-over');
      }
      
      return false;
    }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      const afterElement = getDragAfterElement(document.getElementById('blockEditor'), e.clientY);
      const container = document.getElementById('blockEditor');
      
      if(afterElement == null) {
        container.appendChild(draggedBlock);
      } else {
        container.insertBefore(draggedBlock, afterElement);
      }
      
      scheduleAutoSave();
      return false;
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.block:not(.dragging)')];
      
      return draggableElements.reduce(function(closest, child) {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Keyboard Shortcuts
    function handleBlockKeydown(e) {
      const block = e.target.closest('.block');
      
      // Enter key
      if(e.key === 'Enter' && !e.shiftKey) {
        const type = block.getAttribute('data-type');
        if(['h1', 'h2', 'h3', 'quote'].includes(type)) {
          e.preventDefault();
          insertBlock('text', block);
        } else if(type === 'divider') {
          e.preventDefault();
          insertBlock('text', block);
        } else if(['bullet', 'numbered', 'todo'].includes(type)) {
          if(e.target.textContent.trim() === '') {
            e.preventDefault();
            insertBlock('text', block);
            deleteBlock(block);
          } else {
            e.preventDefault();
            insertBlock(type, block);
          }
        }
      }
      
      // Backspace on empty block
      if(e.key === 'Backspace' && e.target.textContent.trim() === '') {
        const prevBlock = block.previousElementSibling;
        if(prevBlock && prevBlock.classList.contains('block')) {
          e.preventDefault();
          deleteBlock(block);
        }
      }
      
      // Slash menu navigation
      if(document.getElementById('slashMenu').classList.contains('show')) {
        if(e.key === 'ArrowDown') {
          e.preventDefault();
          slashMenuSelectedIndex = Math.min(slashMenuSelectedIndex + 1, slashMenuItems.length - 1);
          updateSlashMenuSelection();
        } else if(e.key === 'ArrowUp') {
          e.preventDefault();
          slashMenuSelectedIndex = Math.max(slashMenuSelectedIndex - 1, 0);
          updateSlashMenuSelection();
        } else if(e.key === 'Enter') {
          e.preventDefault();
          if(slashMenuItems[slashMenuSelectedIndex]) {
            const selectedType = slashMenuItems[slashMenuSelectedIndex].getAttribute('data-type');
            executeSlashCommand(selectedType);
          }
        } else if(e.key === 'Escape') {
          hideSlashMenu();
        }
      }
      
      // Formatting shortcuts
      if(e.ctrlKey || e.metaKey) {
        if(e.key === 'b') {
          e.preventDefault();
          formatText('bold');
        } else if(e.key === 'i') {
          e.preventDefault();
          formatText('italic');
        } else if(e.key === 'u') {
          e.preventDefault();
          formatText('underline');
        } else if(e.key === 's') {
          e.preventDefault();
          savePage(true);
        }
      }
    }

    // Slash Command
    function handleSlashCommand(e) {
      const target = e.target;
      const text = target.textContent;
      
      if(text.startsWith('/')) {
        const query = text.substring(1).toLowerCase();
        showSlashMenu(target.closest('.block'), query);
      } else {
        hideSlashMenu();
      }
    }

    function showSlashMenu(block, query) {
      query = query || '';
      const menu = document.getElementById('slashMenu');
      const rect = block.getBoundingClientRect();
      menu.style.top = (rect.bottom + window.scrollY) + 'px';
      menu.style.left = rect.left + 'px';
      
      // Filter block types
      const filtered = blockTypes.filter(function(bt) {
        return bt.title.toLowerCase().includes(query) || 
               bt.desc.toLowerCase().includes(query) ||
               bt.id.includes(query);
      });
      
      // Group by section
      const sections = {};
      filtered.forEach(function(bt) {
        if(!sections[bt.section]) sections[bt.section] = [];
        sections[bt.section].push(bt);
      });
      
      // Render menu
      menu.innerHTML = '';
      Object.keys(sections).forEach(function(sectionName) {
        const section = document.createElement('div');
        section.className = 'slash-menu-section';
        
        const title = document.createElement('div');
        title.className = 'slash-menu-title';
        title.textContent = sectionName;
        section.appendChild(title);
        
        sections[sectionName].forEach(function(bt) {
          const item = document.createElement('div');
          item.className = 'slash-menu-item';
          item.setAttribute('data-type', bt.id);
          item.innerHTML = `
            <div class="slash-menu-item-icon">${bt.icon.length > 2 ? bt.icon : '<strong>' + bt.icon + '</strong>'}</div>
            <div class="slash-menu-item-content">
              <div class="slash-menu-item-title">${bt.title}</div>
              <div class="slash-menu-item-desc">${bt.desc}</div>
            </div>
          `;
          item.onclick = function() { executeSlashCommand(bt.id); };
          section.appendChild(item);
        });
        
        menu.appendChild(section);
      });
      
      slashMenuItems = Array.from(menu.querySelectorAll('.slash-menu-item'));
      slashMenuSelectedIndex = 0;
      updateSlashMenuSelection();
      
      menu.classList.add('show');
      currentBlock = block;
    }

    function updateSlashMenuSelection() {
      slashMenuItems.forEach(function(item, index) {
        if(index === slashMenuSelectedIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function executeSlashCommand(type) {
      if(!currentBlock) return;
      
      const contentEl = currentBlock.querySelector('.block-content');
      if(contentEl) {
        contentEl.textContent = '';
      }
      
      convertBlockType(currentBlock, type);
      hideSlashMenu();
    }

    function hideSlashMenu() {
      document.getElementById('slashMenu').classList.remove('show');
      slashMenuItems = [];
      slashMenuSelectedIndex = 0;
    }

    // Block Context Menu (3 dots)
    function showBlockContextMenu(event, btn) {
      event.preventDefault();
      event.stopPropagation();
      
      const block = btn.closest('.block');
      const menu = document.getElementById('blockContextMenu');
      const rect = btn.getBoundingClientRect();
      
      menu.style.top = (rect.bottom + window.scrollY) + 'px';
      menu.style.left = rect.left + 'px';
      
      menu.innerHTML = `
        <div class="context-menu-item" onclick="deleteBlock(currentBlock)">
          <span>🗑️</span> Delete
        </div>
        <div class="context-menu-item" onclick="duplicateBlock(currentBlock)">
          <span>📑</span> Duplicate
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-section">
          <div class="context-menu-section-title">Turn Into</div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'text')">
            <span>📝</span> Text
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'h1')">
            <span><strong>H1</strong></span> Heading 1
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'h2')">
            <span><strong>H2</strong></span> Heading 2
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'h3')">
            <span><strong>H3</strong></span> Heading 3
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'todo')">
            <span>☑️</span> To-do
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'bullet')">
            <span>•</span> Bulleted List
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'numbered')">
            <span>1.</span> Numbered List
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'quote')">
            <span>❝</span> Quote
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'code')">
            <span>💻</span> Code
          </div>
          <div class="context-menu-item" onclick="convertBlockType(currentBlock, 'callout')">
            <span>💡</span> Callout
          </div>
        </div>
      `;
      
      currentBlock = block;
      menu.classList.add('show');
    }

    function hideBlockContextMenu() {
      document.getElementById('blockContextMenu').classList.remove('show');
    }

    // Click outside to close
    document.addEventListener('click', function(e) {
      if(!e.target.closest('.slash-menu') && !e.target.closest('.block-content')) {
        hideSlashMenu();
      }
      if(!e.target.closest('.block-context-menu') && !e.target.closest('.block-menu-btn')) {
        hideBlockContextMenu();
      }
      if(!e.target.closest('.formatting-toolbar')) {
        hideFormattingToolbar();
      }
    });

    // Text Selection & Formatting
    function handleTextSelection(e) {
      const selection = window.getSelection();
      if(selection.toString().length > 0) {
        showFormattingToolbar(e);
      } else {
        hideFormattingToolbar();
      }
    }

    function showFormattingToolbar(e) {
      const toolbar = document.getElementById('formattingToolbar');
      const selection = window.getSelection();
      if(selection.rangeCount === 0) return;
      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      
      toolbar.style.top = (rect.top + window.scrollY - 45) + 'px';
      toolbar.style.left = (rect.left + (rect.width / 2) - 150) + 'px';
      toolbar.classList.add('show');
    }

    function hideFormattingToolbar() {
      document.getElementById('formattingToolbar').classList.remove('show');
    }

    function formatText(command, value) {
      document.execCommand(command, false, value);
      scheduleAutoSave();
    }

    function createLink() {
      const url = prompt('Enter URL:');
      if(url) {
        document.execCommand('createLink', false, url);
        scheduleAutoSave();
      }
    }

    // Page Management
    function createNewPage(parentId) {
      currentPageId = null;
      currentPageData = { parentId: parentId || null };
      document.getElementById('titleEditor').value = '';
      document.getElementById('pageIconPicker').textContent = '📄';
      document.getElementById('pageCover').style.display = 'none';
      
      const propsSection = document.getElementById('propertiesSection');
      propsSection.innerHTML = '<button class="add-property-btn" onclick="showAddProperty()">+ Add Property</button>';
      
      const editor = document.getElementById('blockEditor');
      editor.innerHTML = '';
      editor.appendChild(createBlock('text'));
      
      updateBreadcrumbs();
      displayPageTree();
      document.getElementById('titleEditor').focus();
    }

    function savePage(silent) {
      silent = silent || false;
      
      if (!db) { 
        if(!silent) alert('Database not ready'); 
        return; 
      }
      
      const title = document.getElementById('titleEditor').value || 'Untitled';
      const icon = document.getElementById('pageIconPicker').textContent;
      const blocks = [];
      
      document.querySelectorAll('#blockEditor .block').forEach(function(block) {
        const type = block.getAttribute('data-type');
        const contentEl = block.querySelector('.block-content');
        let content = '';
        let data = {};
        
        if(type === 'todo') {
          const checkbox = block.querySelector('.todo-checkbox');
          const text = block.querySelector('.todo-text');
          content = text ? text.innerHTML : '';
          data.checked = checkbox ? checkbox.checked : false;
        } else if(type === 'callout') {
          const iconEl = block.querySelector('.callout-icon');
          const textEl = block.querySelector('.callout-text');
          data.icon = iconEl ? iconEl.textContent : '💡';
          content = textEl ? textEl.innerHTML : '';
        } else if(type === 'image') {
          const img = block.querySelector('.block-image');
          const caption = block.querySelector('.image-caption');
          if(img) data.src = img.src;
          if(caption) data.caption = caption.textContent;
        } else if(type === 'embed') {
          const iframe = block.querySelector('iframe');
          if(iframe) data.url = iframe.src;
        } else if(type === 'link') {
          const linkEl = block.querySelector('.page-link-title');
          if(linkEl) {
            const match = linkEl.getAttribute('onclick').match(/openPage\((\d+)\)/);
            if(match) data.pageId = parseInt(match[1]);
            data.title = linkEl.textContent;
            data.icon = linkEl.textContent.split(' ')[0];
          }
        } else {
          content = contentEl ? contentEl.innerHTML : '';
        }
        
        blocks.push({ type, content, data });
      });
      
      const properties = [];
      document.querySelectorAll('.property').forEach(function(prop) {
        const label = prop.querySelector('.property-label');
        const input = prop.querySelector('.property-input');
        if(label && input) {
          properties.push({
            name: label.textContent.replace(':', ''),
            type: input.getAttribute('data-type') || 'text',
            value: input.value
          });
        }
      });
      
      const pageData = { 
        title: title, 
        icon: icon,
        blocks: blocks,
        properties: properties,
        cover: document.getElementById('pageCover').style.backgroundImage || '',
        lastModified: new Date(),
        favorited: false,
        parentId: currentPageData.parentId || null,
        fullWidth: currentPageData.fullWidth || false
      };
      
      const tx = db.transaction("wiki", "readwrite");
      const store = tx.objectStore("wiki");
      
      if (currentPageId) {
        const getReq = store.get(currentPageId);
        getReq.onsuccess = function(e) {
          const existingPage = e.target.result;
          if(existingPage) {
            pageData.favorited = existingPage.favorited;
            pageData.parentId = existingPage.parentId;
          }
          
          pageData.id = currentPageId;
          store.put(pageData).onsuccess = function() {
            displayPageTree();
            if(!silent) alert('✅ Page saved!');
          };
        };
      } else {
        const req = store.add(pageData);
        req.onsuccess = function(e) {
          currentPageId = e.target.result;
          displayPageTree();
          updateBreadcrumbs();
          if(!silent) alert('✅ Page created!');
        };
        req.onerror = function(e) { 
          console.error('Save failed', e); 
          if(!silent) alert('❌ Failed to save page'); 
        };
      }
    }

    function scheduleAutoSave() {
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(function() { savePage(true); }, 2000);
    }

    function openPage(id) {
      if (!db) return;
      const tx = db.transaction("wiki", "readonly");
      const getReq = tx.objectStore("wiki").get(id);
      getReq.onsuccess = function(e) {
        const page = e.target.result;
        if (!page) return;
        
        currentPageId = page.id;
        currentPageData = page;
        document.getElementById('titleEditor').value = page.title || '';
        document.getElementById('pageIconPicker').textContent = page.icon || '📄';
        
        if(page.cover) {
          document.getElementById('pageCover').style.backgroundImage = page.cover;
          document.getElementById('pageCover').style.display = 'block';
        } else {
          document.getElementById('pageCover').style.display = 'none';
        }
        
        const container = document.getElementById('editorContainer');
        if(page.fullWidth) {
          container.classList.add('full-width');
          document.getElementById('fullWidthToggle').classList.add('active');
        } else {
          container.classList.remove('full-width');
          document.getElementById('fullWidthToggle').classList.remove('active');
        }
        
        const propsSection = document.getElementById('propertiesSection');
        propsSection.innerHTML = '';
        if(page.properties && page.properties.length > 0) {
          page.properties.forEach(function(prop) {
            renderProperty(prop);
          });
        }
        propsSection.innerHTML += '<button class="add-property-btn" onclick="showAddProperty()">+ Add Property</button>';
        
        const editor = document.getElementById('blockEditor');
        editor.innerHTML = '';
        
        if(page.blocks && page.blocks.length > 0) {
          page.blocks.forEach(function(blockData) {
            editor.appendChild(createBlock(blockData.type, blockData.content, blockData.data || {}));
          });
        } else {
          editor.appendChild(createBlock('text'));
        }
        
        updateBreadcrumbs();
        displayPageTree();
        loadComments();
        generateTOC();
      };
      getReq.onerror = function(e) { console.error('Open page failed', e); };
    }

    function confirmDeletePage() {
      if (!currentPageId || !confirm('🗑️ Are you sure you want to delete this page?')) return;
      deletePage(currentPageId);
    }

    function deletePage(id) {
      if (!id) return;
      
      const tx = db.transaction("wiki", "readwrite");
      const delReq = tx.objectStore("wiki").delete(id);
      delReq.onsuccess = function() {
        if (id === currentPageId) {
          currentPageId = null;
          loadInitialPage();
        }
        displayPageTree();
        alert('✅ Page deleted!');
      };
      delReq.onerror = function(e) { console.error('Delete failed', e); alert('❌ Failed to delete page'); };
    }

    function duplicatePage() {
      if(!currentPageId) return;
      
      savePage(true);
      setTimeout(function() {
        const tx = db.transaction("wiki", "readonly");
        const getReq = tx.objectStore("wiki").get(currentPageId);
        getReq.onsuccess = function(e) {
          const page = e.target.result;
          if(!page) return;
          
          const duplicateData = Object.assign({}, page);
          delete duplicateData.id;
          duplicateData.title = page.title + ' (Copy)';
          duplicateData.lastModified = new Date();
          
          const addTx = db.transaction("wiki", "readwrite");
          const addReq = addTx.objectStore("wiki").add(duplicateData);
          addReq.onsuccess = function(ev) {
            openPage(ev.target.result);
            alert('✅ Page duplicated!');
          };
        };
      }, 100);
    }

    function toggleFavorite(id, e) {
      e.stopPropagation();
      
      const tx = db.transaction("wiki", "readwrite");
      const store = tx.objectStore("wiki");
      const getReq = store.get(id);
      
      getReq.onsuccess = function(ev) {
        const page = ev.target.result;
        if(!page) return;
        
        page.favorited = !page.favorited;
        store.put(page).onsuccess = function() {
          displayPageTree();
        };
      };
    }

    function toggleFullWidth() {
      const container = document.getElementById('editorContainer');
      const btn = document.getElementById('fullWidthToggle');
      
      if(container.classList.contains('full-width')) {
        container.classList.remove('full-width');
        btn.classList.remove('active');
        currentPageData.fullWidth = false;
      } else {
        container.classList.add('full-width');
        btn.classList.add('active');
        currentPageData.fullWidth = true;
      }
      
      scheduleAutoSave();
    }

    function displayPageTree() {
      if (!db) return;
      const tx = db.transaction("wiki", "readonly");
      const store = tx.objectStore("wiki");
      const getAllReq = store.getAll();
      
      getAllReq.onsuccess = function(e) {
        const pages = e.target.result || [];
        
        const pageMap = {};
        const rootPages = [];
        
        pages.forEach(function(page) {
          pageMap[page.id] = Object.assign({}, page, { children: [] });
        });
        
        pages.forEach(function(page) {
          if(page.parentId && pageMap[page.parentId]) {
            pageMap[page.parentId].children.push(pageMap[page.id]);
          } else {
            rootPages.push(pageMap[page.id]);
          }
        });
        
        rootPages.sort(function(a,b) {
          return (a.title || '').localeCompare(b.title || '');
        });
        
        const favoritesTree = document.getElementById('favoritesTree');
        favoritesTree.innerHTML = '';
        const favorites = pages.filter(function(p) { return p.favorited; });
        
        if(favorites.length === 0) {
          document.getElementById('favoritesSection').style.display = 'none';
        } else {
          document.getElementById('favoritesSection').style.display = 'block';
          favorites.forEach(function(page) {
            favoritesTree.appendChild(createPageTreeItem(pageMap[page.id], true));
          });
        }
        
        const tree = document.getElementById('pageTree');
        tree.innerHTML = '';
        rootPages.forEach(function(page) {
          tree.appendChild(createPageTreeItem(page));
        });
      };
    }

    function createPageTreeItem(page, skipChildren) {
      skipChildren = skipChildren || false;
      
      const li = document.createElement('li');
      li.className = 'page-tree-item';
      
      const link = document.createElement('div');
      link.className = 'page-link' + (page.id === currentPageId ? ' active' : '');
      
      if(!skipChildren && page.children && page.children.length > 0) {
        const expandIcon = document.createElement('span');
        expandIcon.className = 'expand-icon collapsed';
        expandIcon.onclick = function(e) {
          e.stopPropagation();
          expandIcon.classList.toggle('collapsed');
          expandIcon.classList.toggle('expanded');
          const children = li.querySelector('.children-pages');
          if(children) children.classList.toggle('show');
        };
        link.appendChild(expandIcon);
      } else {
        const spacer = document.createElement('span');
        spacer.style.width = '20px';
        spacer.style.display = 'inline-block';
        link.appendChild(spacer);
      }
      
      const icon = document.createElement('span');
      icon.className = 'page-icon';
      icon.textContent = page.icon || '📄';
      link.appendChild(icon);
      
      const title = document.createElement('span');
      title.className = 'page-title';
      title.textContent = page.title || 'Untitled';
      title.onclick = function() { openPage(page.id); };
      link.appendChild(title);
      
      const actions = document.createElement('div');
      actions.className = 'page-link-actions';
      
      const star = document.createElement('span');
      star.className = 'star-icon' + (page.favorited ? ' starred' : '');
      star.textContent = page.favorited ? '⭐' : '☆';
      star.title = 'Favorite';
      star.onclick = function(e) { toggleFavorite(page.id, e); };
      actions.appendChild(star);
      
      const addSub = document.createElement('span');
      addSub.className = 'add-sub-icon';
      addSub.textContent = '➕';
      addSub.title = 'Add subpage';
      addSub.onclick = function(e) { 
        e.stopPropagation(); 
        createNewPage(page.id); 
      };
      actions.appendChild(addSub);
      
      const delBtn = document.createElement('span');
      delBtn.className = 'delete-icon';
      delBtn.textContent = '🗑️';
      delBtn.title = 'Delete';
      delBtn.onclick = function(e) { 
        e.stopPropagation(); 
        if(confirm('Delete this page?')) deletePage(page.id); 
      };
      actions.appendChild(delBtn);
      
      link.appendChild(actions);
      li.appendChild(link);
      
      if(!skipChildren && page.children && page.children.length > 0) {
        const childrenUl = document.createElement('ul');
        childrenUl.className = 'children-pages';
        page.children.forEach(function(child) {
          childrenUl.appendChild(createPageTreeItem(child));
        });
        li.appendChild(childrenUl);
      }
      
      return li;
    }

    function loadInitialPage() {
      if (!db) {
        createWelcomePage();
        return;
      }
      
      const tx = db.transaction("wiki", "readonly");
      const store = tx.objectStore("wiki");
      const cursorReq = store.openCursor();
      
      cursorReq.onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          openPage(cursor.value.id);
        } else {
          createWelcomePage();
        }
      };
    }

    function createWelcomePage() {
      const welcomePage = {
        title: "Welcome to ShareHive Wiki! 🐝",
        icon: "👋",
        properties: [
          { name: "Type", type: "select", value: "Guide" },
          { name: "Created", type: "date", value: new Date().toISOString().split('T')[0] }
        ],
        blocks: [
          { type: 'callout', content: 'This is a powerful Notion-style wiki with all the features you need to build your knowledge base.', data: { icon: '💡' } },
          { type: 'h2', content: 'Getting Started' },
          { type: 'todo', content: 'Click "New Page" to create a page', data: { checked: false } },
          { type: 'todo', content: 'Type "/" to see all block types', data: { checked: false } },
          { type: 'todo', content: 'Click the ⋯ button to convert blocks', data: { checked: false } },
          { type: 'todo', content: 'Drag blocks to reorder them', data: { checked: false } },
          { type: 'todo', content: 'Select text to format it', data: { checked: false } },
          { type: 'h2', content: 'Block Types' },
          { type: 'bullet', content: 'Text, headings (H1, H2, H3), lists' },
          { type: 'bullet', content: 'To-dos, toggles, quotes' },
          { type: 'bullet', content: 'Callouts, code blocks, tables' },
          { type: 'bullet', content: 'Images, embeds, columns' },
          { type: 'bullet', content: 'Page links and dividers' },
          { type: 'h2', content: 'Features' },
          { type: 'text', content: '✨ <b>Templates</b> - Start with pre-made structures' },
          { type: 'text', content: '🎨 <b>Icons & Covers</b> - Customize your pages' },
          { type: 'text', content: '⭐ <b>Favorites</b> - Star important pages' },
          { type: 'text', content: '📤 <b>Export</b> - Download as Markdown, HTML, or JSON' },
          { type: 'text', content: '💬 <b>Comments</b> - Add comments to pages' },
          { type: 'text', content: '📑 <b>TOC</b> - Auto-generated table of contents' },
          { type: 'h2', content: 'Keyboard Shortcuts' },
          { type: 'bullet', content: 'Type <b>/</b> for block menu' },
          { type: 'bullet', content: 'Click <b>⋯</b> to convert block types' },
          { type: 'bullet', content: '<b>Ctrl+S</b> to save' },
          { type: 'bullet', content: '<b>Ctrl+B</b> for bold' },
          { type: 'bullet', content: '<b>Ctrl+I</b> for italic' },
          { type: 'divider', content: '' },
          { type: 'quote', content: 'Build your second brain, one block at a time. 🧠' }
        ],
        lastModified: new Date(),
        favorited: true,
        parentId: null,
        fullWidth: false
      };
      
      if (db) {
        const addTx = db.transaction("wiki", "readwrite");
        const addReq = addTx.objectStore("wiki").add(welcomePage);
        addReq.onsuccess = function(ev) {
          openPage(ev.target.result);
          displayPageTree();
        };
      } else {
        // If no DB, just render the page directly
        currentPageData = welcomePage;
        document.getElementById('titleEditor').value = welcomePage.title;
        document.getElementById('pageIconPicker').textContent = welcomePage.icon;
        
        const propsSection = document.getElementById('propertiesSection');
        propsSection.innerHTML = '';
        if(welcomePage.properties && welcomePage.properties.length > 0) {
          welcomePage.properties.forEach(function(prop) {
            renderProperty(prop);
          });
        }
        propsSection.innerHTML += '<button class="add-property-btn" onclick="showAddProperty()">+ Add Property</button>';
        
        const editor = document.getElementById('blockEditor');
        editor.innerHTML = '';
        
        if(welcomePage.blocks && welcomePage.blocks.length > 0) {
          welcomePage.blocks.forEach(function(blockData) {
            editor.appendChild(createBlock(blockData.type, blockData.content, blockData.data || {}));
          });
        } else {
          editor.appendChild(createBlock('text'));
        }
        
        updateBreadcrumbs();
        generateTOC();
      }
    }

    // Templates
    function showTemplates() {
      document.getElementById('templatesModal').classList.add('show');
    }

    function applyTemplate(templateName) {
      const template = templates[templateName];
      if(!template) return;
      
      document.getElementById('titleEditor').value = template.title;
      document.getElementById('pageIconPicker').textContent = template.icon;
      
      const propsSection = document.getElementById('propertiesSection');
      propsSection.innerHTML = '';
      if(template.properties && template.properties.length > 0) {
        template.properties.forEach(function(prop) {
          renderProperty(prop);
        });
      }
      propsSection.innerHTML += '<button class="add-property-btn" onclick="showAddProperty()">+ Add Property</button>';
      
      const editor = document.getElementById('blockEditor');
      editor.innerHTML = '';
      
      template.blocks.forEach(function(blockData) {
        editor.appendChild(createBlock(blockData.type, blockData.content, blockData.data || {}));
      });
      
      closeModal('templatesModal');
      scheduleAutoSave();
    }

    // Icon Picker
    function showIconPicker() {
      const grid = document.getElementById('iconPickerGrid');
      grid.innerHTML = '';
      
      icons.forEach(function(icon) {
        const option = document.createElement('div');
        option.className = 'icon-option';
        option.textContent = icon;
        option.onclick = function() {
          document.getElementById('pageIconPicker').textContent = icon;
          closeModal('iconPickerModal');
          scheduleAutoSave();
        };
        grid.appendChild(option);
      });
      
      document.getElementById('iconPickerModal').classList.add('show');
    }

    // Cover Image
    function changeCover() {
      const url = prompt('Enter image URL:');
      if(url) {
        document.getElementById('pageCover').style.backgroundImage = `url(${url})`;
        document.getElementById('pageCover').style.display = 'block';
        scheduleAutoSave();
      }
    }

    function removeCover() {
      document.getElementById('pageCover').style.backgroundImage = '';
      document.getElementById('pageCover').style.display = 'none';
      scheduleAutoSave();
    }

    // Properties
    function showAddProperty() {
      document.getElementById('propertyModal').classList.add('show');
      document.getElementById('propertyName').value = '';
      document.getElementById('propertyName').focus();
    }

    function addProperty(type) {
      const name = document.getElementById('propertyName').value || 'Property';
      const property = { name: name, type: type, value: '' };
      renderProperty(property);
      closeModal('propertyModal');
      scheduleAutoSave();
    }

    function renderProperty(prop) {
      const propsSection = document.getElementById('propertiesSection');
      const addBtn = propsSection.querySelector('.add-property-btn');
      
      const propEl = document.createElement('div');
      propEl.className = 'property';
      
      const label = document.createElement('span');
      label.className = 'property-label';
      label.textContent = prop.name + ':';
      propEl.appendChild(label);
      
      let input;
      if(prop.type === 'checkbox') {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = prop.value === 'true' || prop.value === true;
        input.onchange = function() { scheduleAutoSave(); };
      } else if(prop.type === 'date') {
        input = document.createElement('input');
        input.type = 'date';
        input.value = prop.value;
        input.className = 'property-input';
        input.setAttribute('data-type', prop.type);
        input.oninput = function() { scheduleAutoSave(); };
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = prop.value;
        input.className = 'property-input';
        input.setAttribute('data-type', prop.type);
        input.placeholder = prop.type === 'url' ? 'https://...' : prop.type === 'email' ? 'email@example.com' : 'Value';
        input.oninput = function() { scheduleAutoSave(); };
      }
      
      propEl.appendChild(input);
      
      const removeBtn = document.createElement('span');
      removeBtn.className = 'property-remove';
      removeBtn.textContent = '×';
      removeBtn.onclick = function() {
        propEl.remove();
        scheduleAutoSave();
      };
      propEl.appendChild(removeBtn);
      
      if(addBtn) {
        propsSection.insertBefore(propEl, addBtn);
      } else {
        propsSection.appendChild(propEl);
      }
    }

    // Export
    function showExportMenu() {
      document.getElementById('exportModal').classList.add('show');
    }

    function exportPage(format) {
      if(!currentPageId) {
        alert('Please save the page first');
        return;
      }
      
      const title = document.getElementById('titleEditor').value || 'Untitled';
      const blocks = [];
      
      document.querySelectorAll('#blockEditor .block').forEach(function(block) {
        const type = block.getAttribute('data-type');
        const contentEl = block.querySelector('.block-content');
        blocks.push({ type: type, content: contentEl ? contentEl.textContent : '' });
      });
      
      let output = '';
      let filename = '';
      let mimeType = '';
      
      if(format === 'markdown') {
        output = `# ${title}\n\n`;
        blocks.forEach(function(block) {
          switch(block.type) {
            case 'h1': output += `# ${block.content}\n\n`; break;
            case 'h2': output += `## ${block.content}\n\n`; break;
            case 'h3': output += `### ${block.content}\n\n`; break;
            case 'quote': output += `> ${block.content}\n\n`; break;
            case 'code': output += `\`\`\`\n${block.content}\n\`\`\`\n\n`; break;
            case 'bullet': output += `- ${block.content}\n`; break;
            case 'numbered': output += `1. ${block.content}\n`; break;
            case 'todo': output += `- [ ] ${block.content}\n`; break;
            case 'divider': output += `---\n\n`; break;
            default: output += `${block.content}\n\n`;
          }
        });
        filename = `${title}.md`;
        mimeType = 'text/markdown';
      } else if(format === 'html') {
        output = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>body{font-family:system-ui;max-width:800px;margin:40px auto;padding:20px;line-height:1.6;}</style></head><body>`;
        output += `<h1>${title}</h1>`;
        blocks.forEach(function(block) {
          switch(block.type) {
            case 'h1': output += `<h1>${block.content}</h1>`; break;
            case 'h2': output += `<h2>${block.content}</h2>`; break;
            case 'h3': output += `<h3>${block.content}</h3>`; break;
            case 'quote': output += `<blockquote>${block.content}</blockquote>`; break;
            case 'code': output += `<pre><code>${block.content}</code></pre>`; break;
            case 'bullet': output += `<li>${block.content}</li>`; break;
            case 'divider': output += `<hr>`; break;
            default: output += `<p>${block.content}</p>`;
          }
        });
        output += '</body></html>';
        filename = `${title}.html`;
        mimeType = 'text/html';
      } else if(format === 'json') {
        output = JSON.stringify({ title: title, blocks: blocks }, null, 2);
        filename = `${title}.json`;
        mimeType = 'application/json';
      } else if(format === 'pdf') {
        alert('PDF export: Print this page (Ctrl+P) and select "Save as PDF"');
        window.print();
        closeModal('exportModal');
        return;
      }
      
      const blob = new Blob([output], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      
      closeModal('exportModal');
      alert('✅ Page exported successfully!');
    }

    // Comments
    function toggleComments() {
      const panel = document.getElementById('commentsPanel');
      panel.classList.toggle('show');
      if(panel.classList.contains('show')) {
        loadComments();
      }
    }

    function loadComments() {
      if(!db || !currentPageId) return;
      
      const tx = db.transaction("wikiComments", "readonly");
      const store = tx.objectStore("wikiComments");
      const index = store.index("pageId");
      const getReq = index.getAll(currentPageId);
      
      getReq.onsuccess = function(e) {
        const comments = e.target.result || [];
        const list = document.getElementById('commentsList');
        list.innerHTML = '';
        
        if(comments.length === 0) {
          list.innerHTML = '<p style="color:#888;font-size:14px;">No comments yet. Be the first to comment!</p>';
        } else {
          comments.forEach(function(comment) {
            const div = document.createElement('div');
            div.className = 'comment';
            div.innerHTML = `
              <div class="comment-header">
                <span><strong>${comment.author}</strong></span>
                <span>${new Date(comment.date).toLocaleDateString()}</span>
              </div>
              <div class="comment-text">${comment.text}</div>
            `;
            list.appendChild(div);
          });
        }
      };
    }

    function addComment() {
      const input = document.getElementById('commentInput');
      const text = input.value.trim();
      if(!text || !currentPageId) {
        alert('Please enter a comment');
        return;
      }
      
      const tx = db.transaction("wikiComments", "readwrite");
      const store = tx.objectStore("wikiComments");
      const comment = {
        pageId: currentPageId,
        text: text,
        date: new Date(),
        author: 'You'
      };
      
      store.add(comment).onsuccess = function() {
        input.value = '';
        loadComments();
        alert('✅ Comment added!');
      };
    }

    // TOC
    function toggleTOC() {
      const panel = document.getElementById('tocPanel');
      panel.classList.toggle('show');
      if(panel.classList.contains('show')) {
        generateTOC();
      }
    }

    function generateTOC() {
      const tocList = document.getElementById('tocList');
      tocList.innerHTML = '';
      
      const headings = document.querySelectorAll('#blockEditor .block[data-type="h1"], #blockEditor .block[data-type="h2"], #blockEditor .block[data-type="h3"]');
      
      if(headings.length === 0) {
        tocList.innerHTML = '<li style="color:#888;font-size:13px;">No headings found</li>';
        return;
      }
      
      headings.forEach(function(heading, index) {
        const type = heading.getAttribute('data-type');
        const content = heading.querySelector('.block-content');
        const text = content ? content.textContent : '';
        
        const id = `heading-${index}`;
        heading.id = id;
        
        const li = document.createElement('li');
        li.className = `toc-${type}`;
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.textContent = text;
        a.onclick = function(e) {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        li.appendChild(a);
        tocList.appendChild(li);
      });
    }

    // Breadcrumbs
    function updateBreadcrumbs() {
      const breadcrumbs = document.getElementById('breadcrumbs');
      const title = document.getElementById('titleEditor').value || 'Untitled';
      
      if(!currentPageId || !currentPageData.parentId) {
        breadcrumbs.innerHTML = `
          <a href="#" onclick="event.preventDefault()">📖 Wiki</a>
          <span>›</span>
          <span>${title}</span>
        `;
        return;
      }
      
      const tx = db.transaction("wiki", "readonly");
      const getReq = tx.objectStore("wiki").get(currentPageData.parentId);
      getReq.onsuccess = function(e) {
        const parent = e.target.result;
        if(parent) {
          breadcrumbs.innerHTML = `
            <a href="#" onclick="event.preventDefault()">📖 Wiki</a>
            <span>›</span>
            <a href="#" onclick="event.preventDefault();openPage(${parent.id})">${parent.icon || '📄'} ${parent.title || 'Untitled'}</a>
            <span>›</span>
            <span>${title}</span>
          `;
        }
      };
    }

    // Search
    document.getElementById('search').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.page-tree-item').forEach(function(item) {
        const titleEl = item.querySelector('.page-title');
        if (!titleEl) return;
        if (titleEl.textContent.toLowerCase().includes(query)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });

    // Title change
    document.getElementById('titleEditor').addEventListener('input', function() {
      updateBreadcrumbs();
      scheduleAutoSave();
    });

    // Modal Functions
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // Image Upload
    function uploadImage(placeholder) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(ev) {
          placeholder.outerHTML = `
            <img src="${ev.target.result}" class="block-image" alt="" onclick="viewImage('${ev.target.result}')">
            <div class="image-caption" contenteditable="true" data-placeholder="Add a caption..."></div>
          `;
          scheduleAutoSave();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(function(modal) {
      modal.addEventListener('click', function(e) {
        if(e.target === modal) {
          modal.classList.remove('show');
        }
      });
    });

    // Save on Ctrl+S
    document.addEventListener('keydown', function(e) {
      if((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        savePage(false);
      }
    });

    // Export all data functionality (for settings page integration)
    function exportAllWikiData() {
      if(!db) {
        alert('Database not ready');
        return;
      }
      
      const tx = db.transaction(["wiki", "wikiComments"], "readonly");
      const wikiStore = tx.objectStore("wiki");
      const commentsStore = tx.objectStore("wikiComments");
      
      const wikiReq = wikiStore.getAll();
      const commentsReq = commentsStore.getAll();
      
      Promise.all([
        new Promise(function(resolve) { wikiReq.onsuccess = function() { resolve(wikiReq.result); }; }),
        new Promise(function(resolve) { commentsReq.onsuccess = function() { resolve(commentsReq.result); }; })
      ]).then(function(results) {
        const pages = results[0];
        const comments = results[1];
        
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          pages: pages,
          comments: comments
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sharehive-wiki-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('✅ All wiki data exported successfully!');
      });
    }

    // Make it available globally for settings page
    window.exportAllWikiData = exportAllWikiData;
  </script>
</body>
</html>