<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShareHive - Expense Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Base & Theme (Unchanged) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --primary-color: #0077ff;
      --sidebar-bg: #ffffff;
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0,0,0,0.05);
      --danger-color: #f44336;
      --success-color: #4caf50;
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --sidebar-bg: #2c2c2c;
      --card-bg: #333333;
      --border-color: #444;
      --shadow-color: rgba(0,0,0,0.2);
    }

    /* --- Navbar & Sidebar (Unchanged) --- */
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--primary-color); color: white; }
    .navbar h1 { font-size: 20px; }
    .toggle-btn { background: white; border: none; color: var(--primary-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .container { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 220px; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); }
    .sidebar h2 { font-size: 16px; margin-bottom: 10px; }
    .sidebar a { display: block; text-decoration: none; color: var(--text-color); padding: 8px 10px; border-radius: 5px; margin-bottom: 5px; }
    .sidebar a:hover { background: var(--primary-color); color: white; }

    /* --- Modern Dashboard Layout --- */
    .main { flex: 1; padding: 25px; overflow-y: auto; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .main-header h2 { font-size: 24px; margin: 0; }
    .add-expense-btn {
      padding: 10px 20px; border: none; background: var(--primary-color);
      color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
    }

    /* Summary Cards */
    .summary-cards {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 10px;
    }
    .summary-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .summary-card h3 { font-size: 14px; color: #888; margin-bottom: 8px; font-weight: normal; }
    body.dark .summary-card h3 { color: #aaa; }
    .summary-card .value { font-size: 24px; font-weight: bold; }
    .summary-card .value.total { color: var(--danger-color); }
    .summary-card .value.highest { color: var(--primary-color); }

    /* Transactions Panel */
    .transactions-panel { 
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color);
        padding: 20px;
    }
    .filters-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }
    .filters-container select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        flex-grow: 1;
    }
    .transaction-list { list-style: none; padding: 0; }
    .transaction-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .transaction-item:last-child { border-bottom: none; }
    .category-icon {
        width: 40px; height: 40px;
        border-radius: 50%;
        display: grid; place-items: center;
        margin-right: 15px;
        font-size: 18px;
    }
    .transaction-details { flex-grow: 1; }
    .transaction-details h4 { font-size: 16px; font-weight: 600; }
    .transaction-details small { font-size: 12px; color: #888; }
    body.dark .transaction-details small { color: #aaa; }
    .transaction-amount { font-size: 16px; font-weight: bold; margin-right: 15px; }
    .actions button { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; color: #888; }
    body.dark .actions button { color: #aaa; }


    /* Insights Panel */
    .insights-panel { display: flex; flex-direction: column; gap: 25px; }
    .chart-container {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color);
    }
    .chart-container h3 { font-size: 16px; margin-bottom: 15px; text-align: center; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal { background: var(--bg-color); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; }
    .modal-header .close-btn { font-size: 24px; background: none; border: none; cursor: pointer; color: var(--text-color); }
    .form { display: flex; flex-direction: column; gap: 15px; }
    .form input, .form select {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid var(--border-color); border-radius: 8px;
      background: var(--card-bg); color: var(--text-color);
    }
    .form button { padding: 12px; border: none; background: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }

  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h1>üêù ShareHive - Expense Tracker</h1>
    <button class="toggle-btn" onclick="toggleTheme()">üåô</button>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Sidebar content remains the same -->
        <h2>Menu</h2>
        <a href="index.html">üè† Dashboard</a>
        <a href="notes.html">üìù Notes</a>
        <a href="bookmarks.html">üîñ Bookmarks</a>
        <a href="videos.html">üé¨ Video Links</a>
        <a href="todo.html">‚úÖ To-Do List</a>
        <a href="expense.html"><b>üí∞ Expense Tracker</b></a>
        <a href="planner.html">üìÖ Planner</a>
        <a href="wiki.html">üìñ Wiki</a>
        <a href="uploads.html">üìÇ Upload Files</a>
        <a href="projects.html">üìå Projects</a>
        <a href="watchlist.html">üé• Watchlist</a>
        <a href="courses.html">üìö Courses</a>
        <a href="profile.html">üë§ Profile</a>
        <a href="settings.html">‚öôÔ∏è Settings</a>
        <hr>
        <a href="about.html">‚ÑπÔ∏è About</a>
        <a href="help.html">‚ùì Help</a>
        <a href="faq.html">‚ùî FAQ</a>
        <a href="blog.html">üì∞ Blog</a>
        <a href="contact.html">‚úâÔ∏è Contact</a>
        <a href="join.html">ü§ù Join Us</a>
        <a href="report.html">üêû Report</a>
        <a href="privacy.html">üìú Privacy & Policy</a>
        <a href="community.html">üåç Community</a>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="main-header">
        <h2>Expense Dashboard</h2>
        <button class="add-expense-btn" id="addExpenseBtn">‚ûï Add Expense</button>
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <h3>Total Spend</h3>
          <p class="value total" id="totalSpend">$0.00</p>
        </div>
        <div class="summary-card">
          <h3>Transactions</h3>
          <p class="value" id="transactionCount">0</p>
        </div>
        <div class="summary-card">
          <h3>Average Cost</h3>
          <p class="value" id="averageCost">$0.00</p>
        </div>
        <div class="summary-card">
          <h3>Highest Expense</h3>
          <p class="value highest" id="highestExpense">$0.00</p>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="transactions-panel">
          <div class="filters-container">
            <select id="timeFilter">
              <option value="month">This Month</option>
              <option value="last-month">Last Month</option>
              <option value="year">This Year</option>
              <option value="all">All Time</option>
            </select>
            <select id="categoryFilter">
              <option value="all">All Categories</option>
              <!-- Categories loaded dynamically -->
            </select>
          </div>
          <ul class="transaction-list" id="transactionList">
            <!-- Transactions loaded dynamically -->
          </ul>
        </div>
        
        <div class="insights-panel">
          <div class="chart-container">
            <h3>Category Breakdown</h3>
            <canvas id="expensePieChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>Monthly Trends</h3>
            <canvas id="expenseBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Expense Modal -->
  <div class="modal-overlay" id="expenseModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Expense</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="form">
        <input type="text" id="title" placeholder="Expense title (e.g., Coffee with team)">
        <input type="number" id="amount" placeholder="Amount" step="0.01">
        <input type="text" id="category" placeholder="Category (e.g., Food, Transport)" list="category-list">
        <datalist id="category-list"></datalist>
        <input type="date" id="date">
        <button id="saveBtn">Save Expense</button>
      </div>
    </div>
  </div>

  <script>
    // üåô Dark Mode
    const toggleBtn = document.querySelector('.toggle-btn');
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        toggleBtn.textContent = '‚òÄÔ∏è';
    }

    // --- IndexedDB Setup (with custom categories) ---
    let db;
    const stores = [
  "notes",
  "bookmarks",
  "videos",
  "todos",
  "expenses",
  "planner",
  "wiki",
  "uploads",
  "projects",
  "watchlist",
  "courses",
  "profile",
  "settings",
  "community"
];
    const request = indexedDB.open("ShareHiveDB_Expenses", 21); // New DB or version bump
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("expenses")) {
        db.createObjectStore("expenses", { keyPath: "id", autoIncrement: true });
      }
      if (!db.objectStoreNames.contains("expense_categories")) {
        // Store for custom categories
        db.createObjectStore("expense_categories", { keyPath: "name" });
      }
    };
    request.onsuccess = e => { 
      db = e.target.result; 
      loadInitialData();
    };
    request.onerror = e => console.error("DB error:", e.target.error);

    // --- Modal Handling ---
    const modal = document.getElementById('expenseModal');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const modalTitle = document.getElementById('modalTitle');
    const form = {
        title: document.getElementById('title'),
        amount: document.getElementById('amount'),
        category: document.getElementById('category'),
        date: document.getElementById('date'),
    };
    
    function openModal(expense = null) {
      if (expense) { // Editing
        modalTitle.textContent = 'Edit Expense';
        saveBtn.textContent = 'Update Expense';
        saveBtn.dataset.editId = expense.id;
        form.title.value = expense.title;
        form.amount.value = expense.amount;
        form.category.value = expense.category;
        form.date.value = expense.date;
      } else { // Adding new
        modalTitle.textContent = 'Add New Expense';
        saveBtn.textContent = 'Save Expense';
        delete saveBtn.dataset.editId;
        form.title.value = '';
        form.amount.value = '';
        form.category.value = '';
        form.date.valueAsDate = new Date(); // Default to today
      }
      modal.style.display = 'flex';
    }
    function closeModal() { modal.style.display = 'none'; }
    addExpenseBtn.onclick = () => openModal();
    closeModalBtn.onclick = closeModal;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };

    // --- Data Loading and Rendering ---
    const categoryColors = {};
    const colorPalette = ["#0077ff", "#4caf50", "#ff9800", "#9c27b0", "#f44336", "#795548", "#e91e63", "#2196f3"];
    let colorIndex = 0;

    function getCategoryColor(category) {
        if (!categoryColors[category]) {
            categoryColors[category] = colorPalette[colorIndex % colorPalette.length];
            colorIndex++;
        }
        return categoryColors[category];
    }
    
    function getCategoryIcon(category) {
        const icons = { Food: 'üçî', Transport: 'üöó', Shopping: 'üõçÔ∏è', Bills: 'üßæ', Entertainment: 'üé¨', Health: 'üíä' };
        return icons[category] || category.charAt(0).toUpperCase();
    }

    async function loadInitialData() {
        await populateCategoryFilters();
        await displayDashboard();
    }

    async function populateCategoryFilters() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction("expense_categories", "readonly");
        const store = tx.objectStore("expense_categories");
        const req = store.getAll();

        req.onsuccess = () => {
          const categories = req.result.map(c => c.name).sort();
          const filterSelect = document.getElementById('categoryFilter');
          const datalist = document.getElementById('category-list');
          filterSelect.innerHTML = '<option value="all">All Categories</option>';
          datalist.innerHTML = '';
          categories.forEach(name => {
            filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
            datalist.innerHTML += `<option value="${name}">`;
          });
          resolve();
        };
        req.onerror = () => reject(req.error);
      });
    }
    
    async function displayDashboard() {
      const tx = db.transaction("expenses", "readonly");
      const req = tx.objectStore("expenses").getAll();

      req.onsuccess = () => {
        let expenses = req.result;

        // 1. Apply Filters
        const timeFilter = document.getElementById('timeFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
        
        let filteredExpenses = expenses.filter(exp => {
            const expDate = new Date(exp.date);
            let timeMatch = false;
            if (timeFilter === 'all') timeMatch = true;
            if (timeFilter === 'month' && expDate >= firstDayOfMonth) timeMatch = true;
            if (timeFilter === 'last-month' && expDate >= firstDayOfLastMonth && expDate < firstDayOfMonth) timeMatch = true;
            if (timeFilter === 'year' && expDate >= firstDayOfYear) timeMatch = true;
            
            const categoryMatch = categoryFilter === 'all' || exp.category === categoryFilter;
            return timeMatch && categoryMatch;
        });

        // Sort by most recent
        filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // 2. Update Summary Cards
        const total = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        const count = filteredExpenses.length;
        const average = count > 0 ? total / count : 0;
        const highest = filteredExpenses.reduce((max, exp) => Math.max(max, exp.amount), 0);
        
        document.getElementById('totalSpend').textContent = `$${total.toFixed(2)}`;
        document.getElementById('transactionCount').textContent = count;
        document.getElementById('averageCost').textContent = `$${average.toFixed(2)}`;
        document.getElementById('highestExpense').textContent = `$${highest.toFixed(2)}`;

        // 3. Render Transaction List
        const listEl = document.getElementById('transactionList');
        listEl.innerHTML = '';
        if (filteredExpenses.length === 0) {
            listEl.innerHTML = `<li style="text-align: center; padding: 20px; color: #888;">No transactions found.</li>`;
        } else {
            filteredExpenses.forEach(exp => {
                const li = document.createElement('li');
                li.className = 'transaction-item';
                li.innerHTML = `
                    <div class="category-icon" style="background-color: ${getCategoryColor(exp.category)}; color: white;">
                        ${getCategoryIcon(exp.category)}
                    </div>
                    <div class="transaction-details">
                        <h4>${exp.title}</h4>
                        <small>${exp.category} &bull; ${new Date(exp.date).toLocaleDateString()}</small>
                    </div>
                    <span class="transaction-amount">$${exp.amount.toFixed(2)}</span>
                    <div class="actions">
                        <button onclick="editExpense(${exp.id})" title="Edit">‚úèÔ∏è</button>
                        <button onclick="deleteExpense(${exp.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }
        
        // 4. Update Charts
        updateCharts(filteredExpenses, expenses); // Pass all expenses for trend chart
      };
    }

    // --- CRUD Operations ---
    saveBtn.onclick = async () => {
      const title = form.title.value.trim();
      const amount = parseFloat(form.amount.value);
      const category = form.category.value.trim();
      const date = form.date.value;

      if (!title || isNaN(amount) || !category || !date) {
        alert("Please fill all fields correctly.");
        return;
      }
      
      const editId = saveBtn.dataset.editId;
      const tx = db.transaction(["expenses", "expense_categories"], "readwrite");
      const expensesStore = tx.objectStore("expenses");
      
      const expenseData = { title, amount, category, date };
      if (editId) {
        expenseData.id = Number(editId);
        expensesStore.put(expenseData);
      } else {
        expensesStore.add(expenseData);
      }

      // Add new category if it doesn't exist
      tx.objectStore("expense_categories").put({ name: category });

      tx.oncomplete = () => {
        closeModal();
        loadInitialData(); // Reload everything to reflect changes
      };
    };

    function editExpense(id) {
        const tx = db.transaction("expenses", "readonly");
        const req = tx.objectStore("expenses").get(id);
        req.onsuccess = () => openModal(req.result);
    }

    function deleteExpense(id) {
        if (!confirm("Are you sure you want to delete this expense?")) return;
        const tx = db.transaction("expenses", "readwrite");
        tx.objectStore("expenses").delete(id);
        tx.oncomplete = displayDashboard;
    }

    // --- Chart Logic ---
    let pieChart, barChart;
    function updateCharts(filteredExpenses, allExpenses) {
        const pieCtx = document.getElementById("expensePieChart").getContext("2d");
        const barCtx = document.getElementById("expenseBarChart").getContext("2d");

        // Pie chart (category breakdown of filtered data)
        const categoryTotals = filteredExpenses.reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});
        
        const pieData = {
            labels: Object.keys(categoryTotals),
            datasets: [{
                data: Object.values(categoryTotals),
                backgroundColor: Object.keys(categoryTotals).map(cat => getCategoryColor(cat))
            }]
        };
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(pieCtx, { type: "doughnut", data: pieData, options: { responsive: true, plugins: { legend: { display: false } } } });

        // Bar chart (monthly trends of all data for context)
        const monthlyTotals = allExpenses.reduce((acc, exp) => {
            const month = exp.date.slice(0, 7); // YYYY-MM
            acc[month] = (acc[month] || 0) + exp.amount;
            return acc;
        }, {});
        const months = Object.keys(monthlyTotals).sort().slice(-6); // Last 6 months
        
        const barData = {
            labels: months,
            datasets: [{
                label: "Monthly Spending",
                data: months.map(m => monthlyTotals[m]),
                backgroundColor: "#0077ff",
                borderRadius: 4
            }]
        };
        if (barChart) barChart.destroy();
        barChart = new Chart(barCtx, { type: "bar", data: barData, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
    }

    // --- Event Listeners ---
    document.getElementById('timeFilter').addEventListener('change', displayDashboard);
    document.getElementById('categoryFilter').addEventListener('change', displayDashboard);

  </script>
</body>
</html>
```